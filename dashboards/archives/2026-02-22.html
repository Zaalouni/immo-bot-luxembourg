<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Immo Bot Luxembourg ‚Äî Dashboard</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Immo Bot LU">
<link rel="apple-touch-icon" href="icon.svg">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<style>
:root { --bg: #f1f5f9; }
* { box-sizing: border-box; }
body { background: var(--bg); font-size: .875rem; font-family: "Segoe UI", system-ui, sans-serif; }

/* Navbar */
.top-nav { background: #0f172a; height: 54px; display: flex; align-items: center;
  padding: 0 1.25rem; gap: 1rem; position: sticky; top: 0; z-index: 100;
  box-shadow: 0 2px 8px rgba(0,0,0,.4); }
.top-nav .brand { color: #fff; font-weight: 700; font-size: 1rem; text-decoration: none; }
.top-nav .upd { color: #64748b; font-size: .75rem; margin-left: auto; }
.top-nav .map-btn { background: #3b82f6; color: #fff; border: none; border-radius: 6px;
  padding: .3rem .85rem; font-size: .8rem; font-weight: 600; text-decoration: none;
  transition: background .15s; }
.top-nav .map-btn:hover { background: #2563eb; color: #fff; }

/* KPI cards */
.kpi { border: none; border-left: 4px solid var(--c, #3b82f6);
  box-shadow: 0 1px 3px rgba(0,0,0,.08); border-radius: 10px; background: #fff;
  padding: 1rem 1.1rem; position: relative; overflow: hidden; }
.kpi .val { font-size: 1.65rem; font-weight: 800; color: #0f172a; line-height: 1.15; }
.kpi .lbl { font-size: .68rem; text-transform: uppercase; letter-spacing: .07em;
  color: #94a3b8; margin-top: .2rem; }
.kpi .ico { position: absolute; right: .9rem; top: .75rem;
  font-size: 2rem; opacity: .1; line-height: 1; }
.kpi .sub { font-size: .72rem; color: #64748b; margin-top: .25rem; }

/* Cartes g√©n√©riques */
.card { border: none; box-shadow: 0 1px 3px rgba(0,0,0,.08); border-radius: 10px; }
.card-header { background: transparent; border-bottom: 1px solid #f1f5f9;
  font-size: .75rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: .06em; color: #64748b; padding: .75rem 1rem; }

/* Tableau */
table.dataTable thead th {
  font-size: .7rem; text-transform: uppercase; letter-spacing: .05em;
  background: #1e293b !important; color: #94a3b8 !important;
  border-color: #334155 !important; white-space: nowrap;
}
table.dataTable tbody tr:hover td { background: #eff6ff !important; }
table.dataTable tbody td { vertical-align: middle; padding: .45rem .6rem; }
.al { color: #3b82f6; text-decoration: none; font-weight: 500; }
.al:hover { text-decoration: underline; }
.pm2 { font-size: .7rem; color: #94a3b8; }
.sb { font-size: .68rem; border-radius: 5px; padding: .15em .55em;
  font-weight: 700; color: #fff; white-space: nowrap; }
.dbadge { border-radius: 5px; padding: .1em .5em; font-size: .68rem;
  font-weight: 700; color: #fff; white-space: nowrap; }

/* Filtres */
.filter-lbl { font-size: .68rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: .06em; color: #64748b; margin-bottom: .2rem; }

/* Info bar */
.info-bar { display: flex; flex-wrap: wrap; align-items: center; gap: .5rem;
  font-size: .8rem; color: #64748b; margin-bottom: .75rem; }
.info-bar strong { color: #0f172a; }
</style>
</head>
<body>

<nav class="top-nav">
  <a href="#" class="brand">üè† Immo Bot Luxembourg</a>
  <span class="upd">Mis √† jour : 22/02/2026 12:24</span>
  <a href="map.html" class="map-btn">üó∫Ô∏è Carte (0)</a>
</nav>

<div class="container-fluid px-3 px-md-4 py-3">

<!-- ‚îÄ‚îÄ KPI ‚îÄ‚îÄ -->
<div class="row g-3 mb-3">
  <div class="col-6 col-md-2">
    <div class="kpi" style="--c:#3b82f6">
      <span class="ico">üìã</span>
      <div class="val">0</div>
      <div class="lbl">Annonces</div>
      <div class="sub">0 notifi√©es</div>
    </div>
  </div>
  <div class="col-6 col-md-2">
    <div class="kpi" style="--c:#10b981">
      <span class="ico">üí∞</span>
      <div class="val">0 ‚Ç¨</div>
      <div class="lbl">Prix moyen</div>
    </div>
  </div>
  <div class="col-6 col-md-2">
    <div class="kpi" style="--c:#06b6d4">
      <span class="ico">‚¨áÔ∏è</span>
      <div class="val">0 ‚Ç¨</div>
      <div class="lbl">Prix min</div>
    </div>
  </div>
  <div class="col-6 col-md-2">
    <div class="kpi" style="--c:#f59e0b">
      <span class="ico">‚¨ÜÔ∏è</span>
      <div class="val">0 ‚Ç¨</div>
      <div class="lbl">Prix max</div>
    </div>
  </div>
  <div class="col-6 col-md-2">
    <div class="kpi" style="--c:#8b5cf6">
      <span class="ico">üìê</span>
      <div class="val">0 m¬≤</div>
      <div class="lbl">Surface moy.</div>
    </div>
  </div>
  <div class="col-6 col-md-2">
    <div class="kpi" style="--c:#ec4899">
      <span class="ico">üìä</span>
      <div class="val">0 ‚Ç¨</div>
      <div class="lbl">‚Ç¨/m¬≤ moyen</div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ SITES INFO-BAR ‚îÄ‚îÄ -->
<div class="card mb-3 px-3 py-2" style="font-size:.8rem">
  <span class="text-secondary me-2" style="font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em">Sites actifs :</span>
  
</div>

<!-- ‚îÄ‚îÄ QUALITE DONNEES ‚îÄ‚îÄ -->

<div class="card mb-3">
  <div class="card-header">Qualit√© des donn√©es par site</div>
  <div class="card-body p-0">
    <table class="table table-sm mb-0" style="font-size:.78rem">
      <thead style="background:#1e293b;color:#94a3b8">
        <tr><th>Site</th><th class="text-center">N</th>
            <th class="text-center">Images</th>
            <th class="text-center">Surface</th>
            <th class="text-center">GPS</th>
            <th class="text-center">Email</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- ‚îÄ‚îÄ GRAPHIQUES ‚îÄ‚îÄ -->
<div class="row g-3 mb-3">
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-header">R√©partition par ville</div>
      <div class="card-body d-flex align-items-center justify-content-center" style="min-height:230px">
        <canvas id="cSites"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-header d-flex align-items-center justify-content-between">
        <span>Top 10 villes</span>
        <span style="font-size:.65rem;font-weight:400;color:#94a3b8;text-transform:none;letter-spacing:0">
          Cliquer pour filtrer
        </span>
      </div>
      <div class="card-body d-flex align-items-center" style="min-height:230px">
        <canvas id="cCities" style="cursor:pointer"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-header">Distribution des prix</div>
      <div class="card-body d-flex align-items-center" style="min-height:230px">
        <canvas id="cPrices"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ FILTRES ‚îÄ‚îÄ -->
<div class="card mb-3">
  <div class="card-body py-2">
    <div class="row g-2 align-items-end">
      <div class="col-6 col-md-2">
        <div class="filter-lbl">Site</div>
        <select id="f-site" class="form-select form-select-sm" onchange="applyFilters()">
          <option value="">Tous</option>
          
        </select>
      </div>
      <div class="col-6 col-md-2">
        <div class="filter-lbl">Ville</div>
        <select id="f-city" class="form-select form-select-sm" onchange="applyFilters()">
          <option value="">Toutes</option>
          
        </select>
      </div>
      <div class="col-3 col-md-1">
        <div class="filter-lbl">Prix min</div>
        <input id="f-pmin" type="number" class="form-control form-control-sm" placeholder="1000" step="100">
      </div>
      <div class="col-3 col-md-1">
        <div class="filter-lbl">Prix max</div>
        <input id="f-pmax" type="number" class="form-control form-control-sm" placeholder="3000" step="100">
      </div>
      <div class="col-3 col-md-1">
        <div class="filter-lbl">Surface min</div>
        <input id="f-smin" type="number" class="form-control form-control-sm" placeholder="0">
      </div>
      <div class="col-3 col-md-1">
        <div class="filter-lbl">Pi√®ces</div>
        <select id="f-rooms" class="form-select form-select-sm" onchange="applyFilters()">
          <option value="">Toutes</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4+</option>
        </select>
      </div>
      <div class="col-3 col-md-1">
        <div class="filter-lbl">Distance max</div>
        <select id="f-dist" class="form-select form-select-sm" onchange="applyFilters()">
          <option value="">Toutes</option>
          <option value="2">&lt; 2 km</option>
          <option value="5">&lt; 5 km</option>
          <option value="10">&lt; 10 km</option>
        </select>
      </div>
      <div class="col-auto d-flex align-items-end pb-1">
        <div class="form-check mb-0">
          <input class="form-check-input" type="checkbox" id="f-dispo" onchange="applyFilters()">
          <label class="form-check-label" for="f-dispo" style="font-size:.72rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.06em">Dispo seul.</label>
        </div>
      </div>
      <div class="col-12 col-md-auto d-flex gap-2">
        <button class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">Reset</button>
      </div>
      <div class="col-12 col-md-auto ms-auto d-flex align-items-center gap-2">
        <span class="text-muted small" id="cnt"></span>
        <button id="cmp-btn" class="btn btn-sm btn-warning" style="display:none"
                onclick="openCompare()">‚öñÔ∏è Comparer (<span id="cmp-n">0</span>)</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ TABLEAU ‚îÄ‚îÄ -->
<div class="card mb-4" style="overflow-x:auto">
  <table id="tbl" class="table table-sm table-hover table-bordered mb-0" style="width:100%">
    <thead>
      <tr>
        <th style="width:32px"><input type="checkbox" id="chk-all" onchange="toggleAll(this)"></th>
        <th>Site</th>
        <th>Ville</th>
        <th>Prix ‚Ç¨</th>
        <th>m¬≤</th>
        <th>‚Ç¨/m¬≤</th>
        <th>Ch.</th>
        <th>Dist.</th>
        <th>Titre</th>
        <th>Date</th>
        <th>Dispo</th>
        <th title="Contact email de l'agence / statut notification">üìß / ‚úÖ</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

</div><!-- /container -->

<!-- MODAL COMPARATEUR -->
<div class="modal fade" id="cmp-modal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header" style="background:#0f172a;color:#fff">
        <h5 class="modal-title fw-bold">‚öñÔ∏è Comparateur d'annonces</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-2" id="cmp-body"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const ALL = [];
let filtered = [...ALL];
let cmpSet   = new Set();
let dt;

const SITE_COL = {
  'Athome.lu'   : '#3b82f6',
  'Immotop.lu'  : '#10b981',
  'Luxhome.lu'  : '#06b6d4',
  'VIVI.lu'     : '#f59e0b',
  'Nextimmo.lu' : '#8b5cf6',
  'Newimmo.lu'  : '#ef4444',
  'Unicorn.lu'  : '#64748b',
  'Remax.lu'    : '#ec4899',
  'Sigelux.lu'  : '#84cc16',
  'ImmoStar.lu' : '#f97316',
};

function fmt(n)    { return n != null ? Number(n).toLocaleString('fr-FR') : '‚Äî'; }
function trunc(s,n) { return s && s.length > n ? s.slice(0,n) + '‚Ä¶' : (s || '‚Äî'); }
function dCol(d)   {
  if (d == null) return '#94a3b8';
  return d < 2 ? '#10b981' : d < 5 ? '#3b82f6' : d < 10 ? '#f59e0b' : '#ef4444';
}

function render(data) {
  // Detruire DataTables AVANT de modifier le DOM (sinon destroy() restaure l'ancien tbody)
  if (dt) { dt.destroy(); dt = null; }

  const tb = document.getElementById('tbody');
  tb.innerHTML = '';
  data.forEach(l => {
    const pm2  = (l.price > 0 && l.surface > 0) ? Math.round(l.price / l.surface * 10) / 10 : '';
    const dist = l.distance_km != null
      ? `<span class="dbadge" style="background:${dCol(l.distance_km)}">${l.distance_km.toFixed(1)} km</span>`
      : '<span style="color:#94a3b8">‚Äî</span>';
    const sc = SITE_COL[l.site] || '#64748b';
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><input type="checkbox" class="cchk" value="${l.id}" onchange="togCmp(${l.id},this)"></td>
      <td><span class="sb" style="background:${sc}">${l.site || '‚Äî'}</span></td>
      <td>${l.city || '‚Äî'}</td>
      <td class="fw-bold">${l.price ? fmt(l.price) + ' ‚Ç¨' : '‚Äî'}</td>
      <td>${l.surface || '‚Äî'}</td>
      <td class="pm2">${pm2 ? pm2 + ' ‚Ç¨' : '‚Äî'}</td>
      <td>${l.rooms || '‚Äî'}</td>
      <td>${dist}</td>
      <td><a class="al" href="${l.url}" target="_blank" title="${l.title}">${trunc(l.title, 55)}</a></td>
      <td style="color:#94a3b8;font-size:.72rem">${l.created_at ? l.created_at.slice(0,10) : '‚Äî'}</td>
      <td style="color:#10b981;font-size:.72rem">${l.available_from || ''}</td>
      <td style="text-align:center;white-space:nowrap">
        ${l.contact_email
          ? `<a href="mailto:${l.contact_email}" title="${l.contact_email}"
               style="text-decoration:none;font-size:.8rem">üìß</a>`
          : (l.notified ? '‚úÖ' : '')
        }
      </td>`;
    tb.appendChild(row);
  });

  dt = $('#tbl').DataTable({
    paging: true, pageLength: 25, ordering: true, order: [[3,'asc']], searching: true,
    language: { url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/fr-FR.json' },
    columnDefs: [{ orderable: false, targets: [0, 8] }]
  });

  document.getElementById('chk-all').checked = false;
  const cnt = document.getElementById('cnt');
  if (cnt) cnt.textContent = `${data.length} annonce${data.length > 1 ? 's' : ''}`;
}

function applyFilters() {
  const site  = document.getElementById('f-site').value;
  const city  = document.getElementById('f-city').value.toLowerCase().trim();
  const pmin  = parseFloat(document.getElementById('f-pmin').value) || 0;
  const pmax  = parseFloat(document.getElementById('f-pmax').value) || Infinity;
  const smin  = parseFloat(document.getElementById('f-smin').value) || 0;
  const rooms = document.getElementById('f-rooms').value;
  const dist  = parseFloat(document.getElementById('f-dist').value) || Infinity;
  const dispo = document.getElementById('f-dispo').checked;
  filtered = ALL.filter(l => {
    if (site && l.site !== site) return false;
    if (city && (l.city || '').toLowerCase().trim() !== city) return false;
    if (l.price < pmin || l.price > pmax) return false;
    if (smin > 0 && l.surface > 0 && l.surface < smin) return false;
    if (rooms) {
      if (rooms === '4') { if (l.rooms < 4) return false; }
      else               { if (l.rooms && l.rooms != +rooms) return false; }
    }
    if (dist < Infinity && (l.distance_km == null || l.distance_km > dist)) return false;
    if (dispo && !l.available_from) return false;
    return true;
  });
  render(filtered);
}

function resetFilters() {
  ['f-site','f-city','f-rooms','f-dist'].forEach(id => document.getElementById(id).value = '');
  ['f-pmin','f-pmax','f-smin'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('f-dispo').checked = false;
  filtered = [...ALL];
  render(filtered);
}

function togCmp(id, chk) {
  chk.checked ? cmpSet.add(id) : cmpSet.delete(id);
  document.getElementById('cmp-n').textContent = cmpSet.size;
  document.getElementById('cmp-btn').style.display = cmpSet.size >= 2 ? '' : 'none';
}
function toggleAll(chk) {
  document.querySelectorAll('.cchk').forEach(c => {
    c.checked = chk.checked;
    chk.checked ? cmpSet.add(+c.value) : cmpSet.delete(+c.value);
  });
  document.getElementById('cmp-n').textContent = cmpSet.size;
  document.getElementById('cmp-btn').style.display = cmpSet.size >= 2 ? '' : 'none';
}
function openCompare() {
  const sel = ALL.filter(l => cmpSet.has(l.id));
  if (sel.length < 2) return;
  const fields = [
    ['Site',     l => l.site || '‚Äî'],
    ['Ville',    l => l.city || '‚Äî'],
    ['Prix',     l => l.price ? fmt(l.price) + ' ‚Ç¨' : '‚Äî'],
    ['Surface',  l => l.surface ? l.surface + ' m¬≤' : '‚Äî'],
    ['‚Ç¨/m¬≤',    l => (l.price && l.surface) ? Math.round(l.price / l.surface * 10) / 10 + ' ‚Ç¨' : '‚Äî'],
    ['Pi√®ces',   l => l.rooms || '‚Äî'],
    ['Distance', l => l.distance_km != null ? l.distance_km.toFixed(1) + ' km' : '‚Äî'],
    ['Notifi√©',  l => l.notified ? '‚úÖ' : '‚ùå'],
    ['Date',     l => l.created_at ? l.created_at.slice(0,10) : '‚Äî'],
    ['Contact',  l => l.contact_email
      ? `<a href="mailto:${l.contact_email}" style="color:#3b82f6">${l.contact_email}</a>`
      : '‚Äî'],
    ['Lien',     l => `<a href="${l.url}" target="_blank" class="al">Voir ‚Üí</a>`],
  ];
  let html = '<div style="overflow-x:auto"><table class="table table-sm table-bordered">'
           + '<thead class="table-dark"><tr><th>Crit√®re</th>';
  sel.forEach(l => { html += `<th>${trunc(l.title, 30)}</th>`; });
  html += '</tr></thead><tbody>';
  fields.forEach(([lb, fn]) => {
    html += `<tr><td class="fw-semibold">${lb}</td>`;
    sel.forEach(l => { html += `<td>${fn(l)}</td>`; });
    html += '</tr>';
  });
  html += '</tbody></table></div>';
  document.getElementById('cmp-body').innerHTML = html;
  new bootstrap.Modal(document.getElementById('cmp-modal')).show();
}

// ‚îÄ‚îÄ Graphiques Chart.js ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', () => {
  render(ALL);

  // Donut ‚Äî r√©partition par ville (top 8)
  new Chart(document.getElementById('cSites'), {
    type: 'doughnut',
    data: {
      labels: [],
      datasets: [{ data: [], backgroundColor: [],
        borderWidth: 2, borderColor: '#f1f5f9' }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom', labels: { font: { size: 11 }, boxWidth: 12, padding: 8 } }
      }
    }
  });

  // Barre horizontale ‚Äî top 10 villes (clic ‚Üí filtre tableau)
  const CHART_CITIES = [];
  new Chart(document.getElementById('cCities'), {
    type: 'bar',
    data: {
      labels: CHART_CITIES,
      datasets: [{
        data: [],
        backgroundColor: '#3b82f6bb',
        borderColor: '#3b82f6',
        borderWidth: 1, borderRadius: 4
      }]
    },
    options: {
      indexAxis: 'y', responsive: true,
      plugins: { legend: { display: false } },
      onHover: (e, el) => {
        e.native.target.style.cursor = el.length ? 'pointer' : 'default';
      },
      onClick: (e, el) => {
        if (!el.length) return;
        const city = CHART_CITIES[el[0].index];
        const sel  = document.getElementById('f-city');
        const cityLow = city.toLowerCase().trim();
        // Trouver l'option dont la valeur correspond (insensible a la casse)
        const matchOpt = Array.from(sel.options).find(o => o.value.toLowerCase().trim() === cityLow);
        if (matchOpt && sel.value === matchOpt.value) {
          sel.value = '';
          resetFilters();
        } else {
          if (matchOpt) sel.value = matchOpt.value;
          applyFilters();
        }
        // Scroll doux vers le tableau
        document.querySelector('.card.mb-4').scrollIntoView({ behavior: 'smooth', block: 'start' });
      },
      scales: {
        x: { beginAtZero: true, ticks: { font: { size: 10 } } },
        y: { ticks: { font: { size: 10 } } }
      }
    }
  });

  // Barre ‚Äî distribution prix
  new Chart(document.getElementById('cPrices'), {
    type: 'bar',
    data: {
      labels: ['< 1 500 ‚Ç¨', '1 500‚Äì2 000 ‚Ç¨', '2 000‚Äì2 500 ‚Ç¨', '2 500‚Äì3 000 ‚Ç¨', '> 3 000 ‚Ç¨'],
      datasets: [{
        data: [0, 0, 0, 0, 0],
        backgroundColor: ['#10b981bb','#3b82f6bb','#f59e0bbb','#ef4444bb','#8b5cf6bb'],
        borderColor:     ['#10b981',  '#3b82f6',  '#f59e0b',  '#ef4444',  '#8b5cf6'],
        borderWidth: 1, borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { font: { size: 10 }, stepSize: 1 } },
        x: { ticks: { font: { size: 10 } } }
      }
    }
  });
});

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}
</script>
</body>
</html>