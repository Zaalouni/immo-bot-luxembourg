<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Immo Bot LU ‚Äî Carte</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" rel="stylesheet">
<style>
html, body { margin: 0; padding: 0; height: 100%; overflow: hidden;
  font-family: "Segoe UI", system-ui, sans-serif; }
#map { height: calc(100vh - 52px); width: 100%; }

.top-nav { background: #0f172a; height: 52px; display: flex; align-items: center;
  padding: 0 1.25rem; gap: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,.4); }
.back-btn { color: #94a3b8; text-decoration: none; font-size: .82rem;
  display: flex; align-items: center; gap: .3rem; transition: color .15s; }
.back-btn:hover { color: #fff; }
.nav-title { color: #fff; font-weight: 700; }
.nav-upd { color: #475569; font-size: .75rem; margin-left: auto; }

#panel {
  position: fixed; top: 62px; right: 12px; z-index: 1000;
  width: 230px;
  background: rgba(255,255,255,.96);
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,.2);
  backdrop-filter: blur(10px);
  overflow: hidden;
}
#panel .ph {
  background: #0f172a; color: #fff;
  padding: .6rem .85rem; font-weight: 700; font-size: .82rem;
  display: flex; align-items: center; justify-content: space-between;
  cursor: pointer; user-select: none;
}
#panel .ph .badge-geo {
  background: #3b82f6; color: #fff; border-radius: 20px;
  padding: .1em .6em; font-size: .75rem; font-weight: 700;
}
#panel .ph .toggle-icon {
  font-size: .75rem; color: #94a3b8; transition: transform .2s;
  margin-left: .5rem;
}
#panel.collapsed .ph .toggle-icon { transform: rotate(180deg); }
#panel .pb { padding: .75rem .85rem; }
#panel.collapsed .pb { display: none; }
.filter-lbl {
  font-size: .65rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: .07em; color: #94a3b8; margin-bottom: .2rem;
}
.dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block;
  border: 1px solid rgba(0,0,0,.1); flex-shrink: 0; }
.legend-row { display: flex; align-items: center; gap: .4rem;
  font-size: .75rem; color: #475569; padding: .1rem 0; }

/* Stats rapides */
.qs { display: grid; grid-template-columns: 1fr 1fr; gap: .4rem; margin-bottom: .6rem; }
.qs-item { background: #f8fafc; border-radius: 6px; padding: .35rem .5rem; text-align: center; }
.qs-val { font-size: .95rem; font-weight: 800; color: #0f172a; }
.qs-lbl { font-size: .6rem; text-transform: uppercase; letter-spacing: .05em; color: #94a3b8; }
</style>
</head>
<body>

<nav class="top-nav">
  <a href="index.html" class="back-btn">‚Üê Dashboard</a>
  <span class="nav-title">üó∫Ô∏è Carte des annonces</span>
  <span class="nav-upd">Mis √† jour : 21/02/2026 22:36</span>
</nav>

<div id="map"></div>

<div id="panel">
  <div class="ph" onclick="togglePanel()">
    <span>Annonces g√©olocalis√©es</span>
    <div style="display:flex;align-items:center;gap:.4rem">
      <span class="badge-geo" id="geo-count">0</span>
      <span class="toggle-icon">‚ñ≤</span>
    </div>
  </div>
  <div class="pb">

    <!-- Stats rapides -->
    <div class="qs" id="qs">
      <div class="qs-item">
        <div class="qs-val" id="qs-min">‚Äî</div>
        <div class="qs-lbl">Prix min</div>
      </div>
      <div class="qs-item">
        <div class="qs-val" id="qs-max">‚Äî</div>
        <div class="qs-lbl">Prix max</div>
      </div>
      <div class="qs-item">
        <div class="qs-val" id="qs-avg">‚Äî</div>
        <div class="qs-lbl">Prix moy.</div>
      </div>
      <div class="qs-item">
        <div class="qs-val" id="qs-cnt">‚Äî</div>
        <div class="qs-lbl">Visibles</div>
      </div>
    </div>

    <!-- Filtres -->
    <div style="border-top:1px solid #f1f5f9;padding-top:.6rem;margin-bottom:.6rem">
      <div class="filter-lbl">Ville</div>
      <select id="f-city" class="form-select form-select-sm mb-2">
        <option value="">Toutes les villes</option>
        
      </select>
      <div class="filter-lbl">Site</div>
      <select id="f-site" class="form-select form-select-sm mb-2">
        <option value="">Tous les sites</option>
        
      </select>
      <div class="filter-lbl">Distance max</div>
      <select id="f-dist" class="form-select form-select-sm mb-2">
        <option value="">Toutes distances</option>
        <option value="2">&lt; 2 km</option>
        <option value="5">&lt; 5 km</option>
        <option value="10">&lt; 10 km</option>
      </select>
      <div class="d-flex gap-2">
        <button class="btn btn-sm w-100 fw-semibold"
                style="background:#3b82f6;color:#fff;font-size:.78rem"
                onclick="applyFilters()">Appliquer</button>
        <button class="btn btn-sm btn-outline-secondary w-100"
                style="font-size:.78rem"
                onclick="resetFilters()">Reset</button>
      </div>
    </div>

    <!-- L√©gende -->
    <div style="border-top:1px solid #f1f5f9;padding-top:.6rem">
      <div class="filter-lbl mb-1">L√©gende ‚Äî distance</div>
      <div class="legend-row"><span class="dot" style="background:#10b981"></span>&lt; 2 km du centre</div>
      <div class="legend-row"><span class="dot" style="background:#3b82f6"></span>2 ‚Äì 5 km</div>
      <div class="legend-row"><span class="dot" style="background:#f59e0b"></span>5 ‚Äì 10 km</div>
      <div class="legend-row"><span class="dot" style="background:#ef4444"></span>&gt; 10 km</div>
      <div class="legend-row"><span class="dot" style="background:#94a3b8"></span>Distance inconnue</div>
    </div>

  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
const GEO = [];
let mapObj, clusterGroup;

function fmt(n) { return n != null ? Number(n).toLocaleString('fr-FR') : '‚Äî'; }
function trunc(s,n) { return s && s.length > n ? s.slice(0,n) + '‚Ä¶' : (s || '‚Äî'); }
function dCol(d) {
  if (d == null) return '#94a3b8';
  return d < 2 ? '#10b981' : d < 5 ? '#3b82f6' : d < 10 ? '#f59e0b' : '#ef4444';
}

function updateStats(data) {
  const prices = data.map(l => l.price).filter(p => p > 0);
  const avg = prices.length ? Math.round(prices.reduce((a,b) => a+b,0) / prices.length) : null;
  document.getElementById('qs-min').textContent  = prices.length ? fmt(Math.min(...prices)) + ' ‚Ç¨' : '‚Äî';
  document.getElementById('qs-max').textContent  = prices.length ? fmt(Math.max(...prices)) + ' ‚Ç¨' : '‚Äî';
  document.getElementById('qs-avg').textContent  = avg ? fmt(avg) + ' ‚Ç¨' : '‚Äî';
  document.getElementById('qs-cnt').textContent  = data.length;
  document.getElementById('geo-count').textContent = data.length;
}

function buildMap(data) {
  if (clusterGroup) { mapObj.removeLayer(clusterGroup); }
  clusterGroup = L.markerClusterGroup({
    maxClusterRadius: 40,
    iconCreateFunction: cluster => {
      const n = cluster.getChildCount();
      const sz = n < 10 ? 32 : n < 50 ? 40 : 48;
      return L.divIcon({
        html: `<div style="background:#3b82f6;color:#fff;border-radius:50%;
          width:${sz}px;height:${sz}px;display:flex;align-items:center;
          justify-content:center;font-weight:800;font-size:.8rem;
          box-shadow:0 2px 8px rgba(0,0,0,.35);border:2px solid #fff;">${n}</div>`,
        iconSize: [sz,sz], iconAnchor: [sz/2,sz/2], className: ''
      });
    }
  });

  const bounds = [];
  data.forEach(l => {
    const col = dCol(l.distance_km);
    const pm2 = (l.price > 0 && l.surface > 0) ? Math.round(l.price / l.surface) : null;
    const icon = L.divIcon({
      html: `<div style="background:${col};width:14px;height:14px;border-radius:50%;
        border:2px solid #fff;box-shadow:0 1px 5px rgba(0,0,0,.4)"></div>`,
      iconSize: [14,14], iconAnchor: [7,7], className: ''
    });
    const popup = `
      <div style="min-width:210px;font-size:.85rem;font-family:'Segoe UI',sans-serif">
        <div style="font-weight:700;color:#0f172a;margin-bottom:2px;font-size:.95rem">${l.city || ''}</div>
        <div style="font-size:1.15rem;color:#3b82f6;font-weight:800;margin-bottom:4px">
          ${l.price ? fmt(l.price) + ' ‚Ç¨' : '‚Äî'}
        </div>
        <div style="font-size:.78rem;color:#64748b;margin-bottom:6px">
          ${l.surface ? l.surface + ' m¬≤' : ''}
          ${l.rooms ? ' ¬∑ ' + l.rooms + ' ch.' : ''}
          ${pm2 ? ' ¬∑ ' + pm2 + ' ‚Ç¨/m¬≤' : ''}
        </div>
        ${l.distance_km != null
          ? `<div style="font-size:.75rem;color:#94a3b8;margin-bottom:4px">${l.distance_km.toFixed(1)} km du centre</div>`
          : ''}
        <div style="font-size:.78rem;color:#475569;margin-bottom:8px">${trunc(l.title, 60)}</div>
        <div style="display:flex;align-items:center;justify-content:space-between">
          <span style="font-size:.68rem;color:#94a3b8">${l.site || ''}</span>
          <a href="${l.url}" target="_blank"
             style="background:#3b82f6;color:#fff;text-decoration:none;border-radius:6px;
                    padding:4px 12px;font-size:.78rem;font-weight:700">
            Voir ‚Üí
          </a>
        </div>
      </div>`;
    bounds.push([l.latitude, l.longitude]);
    L.marker([l.latitude, l.longitude], {icon})
      .bindPopup(popup, {maxWidth: 260, className: ''})
      .addTo(clusterGroup);
  });

  clusterGroup.addTo(mapObj);
  if (bounds.length > 0) {
    try { mapObj.fitBounds(bounds, {padding: [30,30], maxZoom: 13}); } catch(e) {}
  }
  updateStats(data);
}

function applyFilters() {
  const city = document.getElementById('f-city').value;
  const site = document.getElementById('f-site').value;
  const dist = parseFloat(document.getElementById('f-dist').value) || Infinity;
  const d = GEO.filter(l => {
    if (city && l.city !== city) return false;
    if (site && l.site !== site) return false;
    if (dist < Infinity && l.distance_km != null && l.distance_km > dist) return false;
    return true;
  });
  buildMap(d);
}

function resetFilters() {
  document.getElementById('f-city').value = '';
  document.getElementById('f-site').value = '';
  document.getElementById('f-dist').value = '';
  buildMap(GEO);
}

function togglePanel() {
  document.getElementById('panel').classList.toggle('collapsed');
}

window.addEventListener('DOMContentLoaded', () => {
  // Repli√© par d√©faut sur mobile (√©cran < 640px)
  if (window.innerWidth < 640) {
    document.getElementById('panel').classList.add('collapsed');
  }
  mapObj = L.map('map').setView([49.6116, 6.1319], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors', maxZoom: 19
  }).addTo(mapObj);
  buildMap(GEO);
});
</script>
</body>
</html>