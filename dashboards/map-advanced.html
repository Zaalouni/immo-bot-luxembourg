<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Avanc√©e - ImmoLux</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
    <link href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css" rel="stylesheet">
    <link href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css" rel="stylesheet">
    <style>
        :root { --primary: #667eea; --primary-dark: #5a6fd6; }
        * { -webkit-tap-highlight-color: transparent; }
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 1rem;
            position: sticky; top: 0; z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 1.3rem; margin: 0 0 0.8rem 0; }

        .nav-link { color: white; opacity: 0.8; text-decoration: none; margin: 0 1rem; }
        .nav-link:hover { opacity: 1; }
        .nav-link.active { opacity: 1; border-bottom: 2px solid white; }

        .container-map {
            display: flex;
            gap: 0;
            height: calc(100vh - 120px);
        }

        .sidebar {
            width: 35%;
            background: white;
            overflow-y: auto;
            border-right: 1px solid #ddd;
            padding: 1rem;
        }

        .map {
            width: 65%;
            height: 100%;
        }

        .listing-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0.8rem;
            margin-bottom: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .listing-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }
        .listing-item.active {
            border-color: var(--primary);
            background: #f8f9ff;
        }

        .listing-item h6 {
            margin: 0 0 0.4rem 0;
            font-size: 0.95rem;
        }

        .listing-item-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.4rem;
        }

        .badge-anomaly {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin: 0.2rem 0.2rem 0.2rem 0;
        }
        .badge-good { background: #d4edda; color: #155724; }
        .badge-high { background: #f8d7da; color: #721c24; }

        .filters {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .leaflet-popup-content {
            font-size: 0.85rem;
            min-width: 200px !important;
        }

        @media (max-width: 768px) {
            .container-map {
                flex-direction: column;
                height: auto;
            }
            .sidebar {
                width: 100%;
                height: 40vh;
                border-right: none;
                border-bottom: 1px solid #ddd;
            }
            .map {
                width: 100%;
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó∫Ô∏è Carte Avanc√©e - ImmoLux</h1>
        <div>
            <a href="index.html" class="nav-link">üìä Dashboard</a>
            <a href="new-listings.html" class="nav-link">üéØ Anomalies</a>
            <a href="map-advanced.html" class="nav-link active">üó∫Ô∏è Carte+</a>
            <a href="nearby.html" class="nav-link">üìç Autour de moi</a>
        </div>
    </div>

    <div class="container-map">
        <div class="sidebar">
            <div class="filters">
                <select id="filterCity" class="form-select form-select-sm mb-2">
                    <option value="">Toutes les villes</option>
                </select>
                <select id="filterSite" class="form-select form-select-sm mb-2">
                    <option value="">Tous les sites</option>
                </select>
                <button class="btn btn-sm btn-primary w-100" onclick="applyMapFilters()">Filtrer</button>
            </div>

            <div id="listings" style="height: 100%;"></div>
        </div>

        <div id="map" class="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
    <script src="data/listings.json" type="application/json"></script>
    <script src="data/anomalies.js"></script>
    <script>
        let map;
        let markerClusterGroup;
        let currentMarkers = {};
        let allMarkers = [];

        const ANOMALY_COLORS = {
            'GOOD_DEAL': '#28a745',
            'HIGH': '#dc3545',
            'NORMAL': '#667eea'
        };

        async function init() {
            try {
                // Charger les listings
                const response = await fetch('data/listings.json');
                LISTINGS = await response.json();

                initMap();
                populateFilters();
                renderListings(LISTINGS);
                addMarkersToMap(LISTINGS);
            } catch (e) {
                console.error('Erreur:', e);
                document.getElementById('listings').innerHTML = '<div class="text-danger">Erreur chargement donn√©es</div>';
            }
        }

        function initMap() {
            // Centrer sur Luxembourg
            const centerLat = 49.6116;
            const centerLng = 6.1319;

            map = L.map('map').setView([centerLat, centerLng], 10);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);

            // Clustering
            markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 80,
                iconCreateFunction: createClusterIcon
            });
            map.addLayer(markerClusterGroup);
        }

        function createClusterIcon(cluster) {
            const count = cluster.getChildCount();
            const size = count < 10 ? 40 : count < 50 ? 50 : 60;
            return L.divIcon({
                html: `<div style="background:#667eea; color:white; width:${size}px; height:${size}px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:0.85rem;">${count}</div>`,
                iconSize: [size, size],
                className: ''
            });
        }

        function populateFilters() {
            const cities = [...new Set(LISTINGS.map(l => l.city).filter(c => c))].sort();
            const sites = [...new Set(LISTINGS.map(l => l.site).filter(s => s))].sort();

            const citySelect = document.getElementById('filterCity');
            cities.forEach(city => {
                const opt = document.createElement('option');
                opt.value = city;
                opt.textContent = city;
                citySelect.appendChild(opt);
            });

            const siteSelect = document.getElementById('filterSite');
            sites.forEach(site => {
                const opt = document.createElement('option');
                opt.value = site;
                opt.textContent = site;
                siteSelect.appendChild(opt);
            });
        }

        function applyMapFilters() {
            const city = document.getElementById('filterCity').value;
            const site = document.getElementById('filterSite').value;

            const filtered = LISTINGS.filter(l => {
                return (!city || l.city === city) && (!site || l.site === site);
            });

            // Clear map
            markerClusterGroup.clearLayers();
            document.getElementById('listings').innerHTML = '';
            renderListings(filtered);
            addMarkersToMap(filtered);
        }

        function renderListings(listings) {
            const container = document.getElementById('listings');
            if (listings.length === 0) {
                container.innerHTML = '<div class="text-muted">Aucune annonce</div>';
                return;
            }

            container.innerHTML = listings.map(l => {
                const anomaly = ANOMALIES[l.listing_id] || 'NORMAL';
                const badgeClass = anomaly === 'GOOD_DEAL' ? 'badge-good' : anomaly === 'HIGH' ? 'badge-high' : '';
                const badgeText = anomaly === 'GOOD_DEAL' ? '‚úÖ Bon Affaire' : anomaly === 'HIGH' ? '‚ö†Ô∏è Prix Haut' : '';

                return `
                    <div class="listing-item" onclick="selectListing('${l.listing_id}')">
                        <h6>${l.title}</h6>
                        <div class="listing-item-price">${l.price}‚Ç¨</div>
                        <div class="small">
                            <span class="badge bg-secondary">${l.city}</span>
                            ${anomaly !== 'NORMAL' ? `<span class="badge-anomaly ${badgeClass}">${badgeText}</span>` : ''}
                        </div>
                        <div class="small text-muted mt-1">
                            ${l.surface > 0 ? `${l.surface}m¬≤ | ` : ''}
                            ${l.rooms > 0 ? `${l.rooms} ch | ` : ''}
                            ${l.time_ago}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addMarkersToMap(listings) {
            currentMarkers = {};

            listings.forEach(listing => {
                if (!listing.latitude || !listing.longitude) return;

                const anomaly = ANOMALIES[listing.listing_id] || 'NORMAL';
                const color = ANOMALY_COLORS[anomaly];

                const marker = L.circleMarker([listing.latitude, listing.longitude], {
                    radius: 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0.7
                }).bindPopup(`
                    <strong>${listing.title}</strong><br/>
                    <strong>${listing.price}‚Ç¨</strong><br/>
                    ${listing.surface > 0 ? listing.surface + 'm¬≤ | ' : ''}
                    ${listing.rooms > 0 ? listing.rooms + ' ch' : ''}<br/>
                    <small>${listing.city}</small><br/>
                    <a href="${listing.url}" target="_blank" class="btn btn-sm btn-primary mt-2">Voir</a>
                `);

                marker.on('click', () => selectListing(listing.listing_id));
                markerClusterGroup.addLayer(marker);
                currentMarkers[listing.listing_id] = marker;
            });
        }

        function selectListing(listingId) {
            // Highlight item in sidebar
            document.querySelectorAll('.listing-item').forEach(el => el.classList.remove('active'));
            const items = document.querySelectorAll('.listing-item');
            const listing = LISTINGS.find(l => l.listing_id === listingId);
            if (listing) {
                items.forEach(el => {
                    if (el.textContent.includes(listing.title)) {
                        el.classList.add('active');
                        el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                });
            }

            // Center map on marker
            const marker = currentMarkers[listingId];
            if (marker) {
                map.setView(marker.getLatLng(), 14);
                marker.openPopup();
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
