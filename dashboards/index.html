<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Immo Bot Luxembourg ‚Äî Dashboard</title>
<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#212529">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Immo Bot LU">
<link rel="apple-touch-icon" href="icon.svg">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" rel="stylesheet">
<style>
  body { background:#f8f9fa; font-size:.9rem; }
  .stat-card { border-radius:12px; border:none; box-shadow:0 2px 8px rgba(0,0,0,.08); }
  .stat-val  { font-size:1.8rem; font-weight:700; line-height:1; }
  .stat-label { font-size:.75rem; color:#6c757d; text-transform:uppercase; letter-spacing:.05em; }
  #map { height:520px; border-radius:0 0 12px 12px; }
  .map-card { border-radius:12px; border:none; box-shadow:0 2px 12px rgba(0,0,0,.12); overflow:hidden; }
  .filter-card, .table-container { border-radius:12px; border:none; box-shadow:0 2px 8px rgba(0,0,0,.08); background:white; }
  .badge-site { font-size:.7rem; padding:.25em .5em; }
  #compare-btn { display:none; }
  a.al { text-decoration:none; color:#0d6efd; }
  a.al:hover { text-decoration:underline; }
  .pm2 { font-size:.75rem; color:#6c757d; }
  th { white-space:nowrap; }
  .map-header { background:#212529; color:#fff; padding:.55rem 1rem; font-weight:600; font-size:.95rem;
    display:flex; align-items:center; justify-content:space-between; border-radius:12px 12px 0 0; }
  .map-legend { display:flex; gap:10px; font-size:.75rem; color:#ccc; align-items:center; }
  .dot { width:10px; height:10px; border-radius:50%; display:inline-block; border:1px solid #fff5; }
  .map-info { position:absolute; bottom:10px; left:10px; z-index:1000;
    background:rgba(255,255,255,.92); border-radius:8px; padding:4px 10px;
    font-size:.78rem; box-shadow:0 1px 5px rgba(0,0,0,.2); }
  .price-pill { display:inline-block; background:#0d6efd; color:#fff; border-radius:10px;
    padding:1px 7px; font-size:.7rem; font-weight:600; white-space:nowrap; }
</style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-3">
  <div class="container-fluid">
    <span class="navbar-brand fw-bold">üè† Immo Bot Luxembourg</span>
    <span class="text-secondary small">Mis √† jour : 20/02/2026 21:24</span>
  </div>
</nav>

<div class="container-fluid px-4">

<!-- STATS -->
<div class="row g-3 mb-3">
  <div class="col-6 col-md-2"><div class="card stat-card h-100"><div class="card-body text-center">
    <div class="stat-val text-primary">69</div><div class="stat-label">Annonces</div>
  </div></div></div>
  <div class="col-6 col-md-2"><div class="card stat-card h-100"><div class="card-body text-center">
    <div class="stat-val text-success">2,153‚Ç¨</div><div class="stat-label">Prix moyen</div>
  </div></div></div>
  <div class="col-6 col-md-2"><div class="card stat-card h-100"><div class="card-body text-center">
    <div class="stat-val text-info">112 m¬≤</div><div class="stat-label">Surface moy.</div>
  </div></div></div>
  <div class="col-6 col-md-2"><div class="card stat-card h-100"><div class="card-body text-center">
    <div class="stat-val text-warning">23.6‚Ç¨</div><div class="stat-label">‚Ç¨/m¬≤ moyen</div>
  </div></div></div>
  <div class="col-6 col-md-2"><div class="card stat-card h-100"><div class="card-body text-center">
    <div class="stat-val text-danger">1,500‚Ç¨</div><div class="stat-label">Prix min</div>
  </div></div></div>
  <div class="col-6 col-md-2"><div class="card stat-card h-100"><div class="card-body text-center">
    <div class="stat-val">2,400‚Ç¨</div><div class="stat-label">Prix max</div>
  </div></div></div>
</div>

<div class="card filter-card mb-3 p-2">
  <span class="text-muted small me-2">Sites :</span><span class="badge bg-secondary me-1">Athome.lu: 47</span> <span class="badge bg-secondary me-1">Immotop.lu: 3</span> <span class="badge bg-secondary me-1">Newimmo.lu: 3</span> <span class="badge bg-secondary me-1">Nextimmo.lu: 9</span> <span class="badge bg-secondary me-1">Remax.lu: 3</span> <span class="badge bg-secondary me-1">VIVI.lu: 4</span>
  <span class="ms-3 text-muted small">Notifi√©es : <strong>69</strong></span>
  <span class="ms-3 text-muted small">Distance moy. : <strong>7.3 km</strong></span>
  <span class="ms-3 text-muted small">G√©olocalis√©es : <strong>65</strong></span>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CARTE ‚Äî affich√©e EN PREMIER, grande, avec clusters
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="map-card mb-4" style="position:relative">
  <div class="map-header">
    <span>üó∫Ô∏è Carte des annonces g√©olocalis√©es &nbsp;<span id="map-count" class="badge bg-primary">65</span></span>
    <div class="map-legend">
      <span><span class="dot" style="background:#198754"></span> &lt; 2 km</span>
      <span><span class="dot" style="background:#0d6efd"></span> &lt; 5 km</span>
      <span><span class="dot" style="background:#ffc107"></span> &lt; 10 km</span>
      <span><span class="dot" style="background:#dc3545"></span> 10+ km</span>
      <span><span class="dot" style="background:#6c757d"></span> N/A</span>
    </div>
  </div>
  <div id="map"></div>
</div>

<!-- FILTRES -->
<div class="card filter-card mb-3">
  <div class="card-header fw-semibold py-2">üîç Filtres ‚Äî liste &amp; carte</div>
  <div class="card-body py-2">
    <div class="row g-2 align-items-end">
      <div class="col-12 col-md-2">
        <label class="form-label mb-1 small">Ville</label>
        <select id="f-city" class="form-select form-select-sm" multiple size="3">
          <option value="Alzingen">Alzingen</option>
<option value="Belval">Belval</option>
<option value="Belvaux">Belvaux</option>
<option value="Bereldange">Bereldange</option>
<option value="Bertrange">Bertrange</option>
<option value="Bissen">Bissen</option>
<option value="Bridel">Bridel</option>
<option value="Brouch (Mersch)">Brouch (Mersch)</option>
<option value="Contern">Contern</option>
<option value="Dudelange">Dudelange</option>
<option value="Emerange">Emerange</option>
<option value="Esch-sur-Alzette">Esch-sur-Alzette</option>
<option value="Filsdorf">Filsdorf</option>
<option value="Garnich">Garnich</option>
<option value="Gonderange">Gonderange</option>
<option value="Hassel">Hassel</option>
<option value="Hautcharage">Hautcharage</option>
<option value="Hesperange">Hesperange</option>
<option value="Junglinster">Junglinster</option>
<option value="Luxembourg">Luxembourg</option>
<option value="Luxembourg Neudorf">Luxembourg Neudorf</option>
<option value="Luxembourg-Belair">Luxembourg-Belair</option>
<option value="Luxembourg-Bonnevoie">Luxembourg-Bonnevoie</option>
<option value="Luxembourg-Centre ville">Luxembourg-Centre ville</option>
<option value="Luxembourg-Centre Ville">Luxembourg-Centre Ville</option>
<option value="Luxembourg-Cessange">Luxembourg-Cessange</option>
<option value="Luxembourg-Gare">Luxembourg-Gare</option>
<option value="Luxembourg-Gasperich - Cloche d'or">Luxembourg-Gasperich - Cloche d'or</option>
<option value="Luxembourg-Hamm">Luxembourg-Hamm</option>
<option value="Luxembourg-Hollerich">Luxembourg-Hollerich</option>
<option value="Luxembourg-Kirchberg">Luxembourg-Kirchberg</option>
<option value="Luxembourg-Pfaffenthal">Luxembourg-Pfaffenthal</option>
<option value="Luxembourg-Weimerskirch">Luxembourg-Weimerskirch</option>
<option value="Mamer">Mamer</option>
<option value="Niederanven">Niederanven</option>
<option value="Olm">Olm</option>
<option value="Reuler">Reuler</option>
<option value="Roeser">Roeser</option>
<option value="Rollingen">Rollingen</option>
<option value="Sanem">Sanem</option>
<option value="Senningerberg">Senningerberg</option>
<option value="Sprinkange">Sprinkange</option>
<option value="Steinsel">Steinsel</option>
<option value="Weiswampach">Weiswampach</option>
<option value="Wellenstein">Wellenstein</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <label class="form-label mb-1 small">Site</label>
        <select id="f-site" class="form-select form-select-sm" multiple size="3">
          <option value="Athome.lu">Athome.lu</option>
<option value="Immotop.lu">Immotop.lu</option>
<option value="Newimmo.lu">Newimmo.lu</option>
<option value="Nextimmo.lu">Nextimmo.lu</option>
<option value="Remax.lu">Remax.lu</option>
<option value="VIVI.lu">VIVI.lu</option>
        </select>
      </div>
      <div class="col-6 col-md-1">
        <label class="form-label mb-1 small">Prix min ‚Ç¨</label>
        <input id="f-pmin" type="number" class="form-control form-control-sm" placeholder="1000" step="100">
      </div>
      <div class="col-6 col-md-1">
        <label class="form-label mb-1 small">Prix max ‚Ç¨</label>
        <input id="f-pmax" type="number" class="form-control form-control-sm" placeholder="3000" step="100">
      </div>
      <div class="col-6 col-md-1">
        <label class="form-label mb-1 small">Surface min m¬≤</label>
        <input id="f-smin" type="number" class="form-control form-control-sm" placeholder="0">
      </div>
      <div class="col-6 col-md-1">
        <label class="form-label mb-1 small">Pi√®ces</label>
        <select id="f-rooms" class="form-select form-select-sm">
          <option value="">Toutes</option>
          <option value="1">1</option><option value="2">2</option>
          <option value="3">3</option><option value="4">4+</option>
        </select>
      </div>
      <div class="col-6 col-md-1">
        <label class="form-label mb-1 small">Dist. max km</label>
        <input id="f-dmax" type="number" class="form-control form-control-sm" placeholder="15">
      </div>
      <div class="col-6 col-md-1">
        <label class="form-label mb-1 small">Notifi√©</label>
        <select id="f-notif" class="form-select form-select-sm">
          <option value="">Tous</option>
          <option value="1">Oui</option><option value="0">Non</option>
        </select>
      </div>
      <div class="col-12 col-md-2 d-flex gap-2">
        <button class="btn btn-primary btn-sm w-100" onclick="applyFilters()">Appliquer</button>
        <button class="btn btn-outline-secondary btn-sm w-100" onclick="resetFilters()">Reset</button>
      </div>
    </div>
  </div>
</div>

<div class="mb-3 d-flex align-items-center gap-3">
  <span class="text-muted small" id="result-count"></span>
  <button id="compare-btn" class="btn btn-warning btn-sm" onclick="openCompare()">
    ‚öñÔ∏è Comparer (<span id="cmp-cnt">0</span> s√©lectionn√©es)
  </button>
</div>

<!-- TABLEAU -->
<div class="table-container mb-5" style="overflow-x:auto">
  <table id="tbl" class="table table-hover table-sm table-bordered mb-0" style="width:100%">
    <thead class="table-dark">
      <tr>
        <th><input type="checkbox" id="chk-all" onchange="toggleAll(this)"></th>
        <th>Site</th><th>Ville</th><th>Prix ‚Ç¨</th><th>m¬≤</th><th>‚Ç¨/m¬≤</th>
        <th>Pi√®ces</th><th>Distance</th><th>Titre</th><th>Date</th><th>‚úâÔ∏è</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

</div>

<!-- MODAL COMPARATEUR -->
<div class="modal fade" id="cmp-modal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">‚öñÔ∏è Comparateur</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="cmp-body"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
const ALL = [{"id": 69, "listing_id": "remax_280221016-160", "site": "Remax.lu", "title": "Appartement √† louer ‚Äî Bertrange", "city": "Bertrange", "price": 1950, "rooms": 2, "surface": 98, "url": "https://www.remax.lu/fr-lu/mandats-de-vente/appartement/a-louer/bertrange/280221016-160", "latitude": 49.61, "longitude": 6.05, "distance_km": 6.2, "created_at": "2026-02-20 20:07:50", "notified": 1}, {"id": 68, "listing_id": "remax_280221031-193", "site": "Remax.lu", "title": "Appartement √† louer ‚Äî Mamer", "city": "Mamer", "price": 2150, "rooms": 2, "surface": 80, "url": "https://www.remax.lu/fr-lu/mandats-de-vente/appartement/a-louer/mamer/mamer-8-rue-marie-jeanne-birkel-8241/280221031-193", "latitude": 49.627, "longitude": 6.023, "distance_km": 8.6, "created_at": "2026-02-20 20:07:39", "notified": 1}, {"id": 67, "listing_id": "vivi_202433", "site": "VIVI.lu", "title": "Appartement 2 chambres √† louer", "city": "Reuler", "price": 1600, "rooms": 2, "surface": 102, "url": "https://www.vivi.lu/fr/propriete/lieu/appartement/reuler/appartement-2-chambres-a-louer/202433", "latitude": null, "longitude": null, "distance_km": null, "created_at": "2026-02-20 20:07:28", "notified": 1}, {"id": 66, "listing_id": "vivi_210717", "site": "VIVI.lu", "title": "Appartement 3 chambres √† louer", "city": "Reuler", "price": 2100, "rooms": 3, "surface": 135, "url": "https://www.vivi.lu/fr/propriete/lieu/appartement/reuler/appartement-3-chambres-a-louer/210717", "latitude": null, "longitude": null, "distance_km": null, "created_at": "2026-02-20 20:07:18", "notified": 1}, {"id": 65, "listing_id": "vivi_211525", "site": "VIVI.lu", "title": "Appartement 2 chambres √† louer", "city": "Weiswampach", "price": 1500, "rooms": 2, "surface": 88, "url": "https://www.vivi.lu/fr/propriete/lieu/appartement/weiswampach/appartement-2-chambres-a-louer/211525", "latitude": null, "longitude": null, "distance_km": null, "created_at": "2026-02-20 20:07:07", "notified": 1}, {"id": 64, "listing_id": "vivi_210570", "site": "VIVI.lu", "title": "Appartement 2 chambres √† louer", "city": "Bissen", "price": 2000, "rooms": 2, "surface": 81, "url": "https://www.vivi.lu/fr/propriete/lieu/appartement/bissen/appartement-2-chambres-a-louer/210570", "latitude": null, "longitude": null, "distance_km": null, "created_at": "2026-02-20 20:06:57", "notified": 1}, {"id": 63, "listing_id": "remax_280351001-7", "site": "Remax.lu", "title": "Appartement √† louer ‚Äî Luxembourg", "city": "Luxembourg", "price": 2100, "rooms": 2, "surface": 1260, "url": "https://www.remax.lu/fr-lu/mandats-de-vente/appartement/a-louer/luxembourg/rue-auguste-charles-2-1260/280351001-7", "latitude": 49.6116, "longitude": 6.1319, "distance_km": 1.3, "created_at": "2026-02-20 20:06:46", "notified": 1}, {"id": 62, "listing_id": "nextimmo_86002754", "site": "Nextimmo.lu", "title": "Appartement Emerange", "city": "Emerange", "price": 2400, "rooms": 4, "surface": 123, "url": "https://nextimmo.lu/en/details/86002754", "latitude": 49.48752, "longitude": 6.29127, "distance_km": 16.9, "created_at": "2026-02-20 20:06:36", "notified": 1}, {"id": 61, "listing_id": "nextimmo_5710", "site": "Nextimmo.lu", "title": "Appartement Luxembourg-Hamm", "city": "Luxembourg-Hamm", "price": 1890, "rooms": 2, "surface": 81, "url": "https://nextimmo.lu/en/details/5710", "latitude": 49.6116, "longitude": 6.1319, "distance_km": 1.3, "created_at": "2026-02-20 20:06:26", "notified": 1}, {"id": 60, "listing_id": "nextimmo_85075359", "site": "Nextimmo.lu", "title": "Appartement Wellenstein", "city": "Wellenstein", "price": 1800, "rooms": 2, "surface": 110, "url": "https://nextimmo.lu/en/details/85075359", "latitude": 49.52284, "longitude": 6.34504, "distance_km": 17.5, "created_at": "2026-02-20 20:06:15", "notified": 1}, {"id": 59, "listing_id": "nextimmo_86748114", "site": "Nextimmo.lu", "title": "Appartement Luxembourg-Hollerich", "city": "Luxembourg-Hollerich", "price": 2150, "rooms": 2, "surface": 85, "url": "https://nextimmo.lu/en/details/86748114", "latitude": 49.60034, "longitude": 6.12105, "distance_km": 0.9, "created_at": "2026-02-20 20:06:05", "notified": 1}, {"id": 58, "listing_id": "nextimmo_83177499", "site": "Nextimmo.lu", "title": "Appartement Luxembourg-Belair", "city": "Luxembourg-Belair", "price": 2100, "rooms": 2, "surface": 80, "url": "https://nextimmo.lu/en/details/83177499", "latitude": 49.60751, "longitude": 6.10969, "distance_km": 2.0, "created_at": "2026-02-20 20:05:55", "notified": 1}, {"id": 57, "listing_id": "nextimmo_86750963", "site": "Nextimmo.lu", "title": "Appartement Olm", "city": "Olm", "price": 2300, "rooms": 2, "surface": 80, "url": "https://nextimmo.lu/en/details/86750963", "latitude": 49.65509, "longitude": 5.99296, "distance_km": 11.9, "created_at": "2026-02-20 20:05:44", "notified": 1}, {"id": 56, "listing_id": "nextimmo_1876275", "site": "Nextimmo.lu", "title": "Appartement Luxembourg-Pfaffenthal", "city": "Luxembourg-Pfaffenthal", "price": 2100, "rooms": 2, "surface": 88, "url": "https://nextimmo.lu/en/details/1876275", "latitude": 49.6158, "longitude": 6.13289, "distance_km": 1.8, "created_at": "2026-02-20 20:05:34", "notified": 1}, {"id": 55, "listing_id": "newimmo_127084", "site": "Newimmo.lu", "title": "Appartement - Luxembourg Neudorf", "city": "Luxembourg Neudorf", "price": 2000, "rooms": 0, "surface": 0, "url": "https://www.newimmo.lu/fr/louer/appartement/luxembourg-neudorf/127084-appartement-luxembourg-neudorf/", "latitude": 49.6116, "longitude": 6.1319, "distance_km": 1.3, "created_at": "2026-02-20 20:05:23", "notified": 1}, {"id": 54, "listing_id": "newimmo_127231", "site": "Newimmo.lu", "title": "Appartement - Luxembourg", "city": "Luxembourg", "price": 1900, "rooms": 0, "surface": 0, "url": "https://www.newimmo.lu/fr/louer/appartement/luxembourg/127231-appartement-luxembourg/", "latitude": 49.6116, "longitude": 6.1319, "distance_km": 1.3, "created_at": "2026-02-20 20:05:13", "notified": 1}, {"id": 53, "listing_id": "newimmo_127171", "site": "Newimmo.lu", "title": "Appartement - Bertrange", "city": "Bertrange", "price": 1500, "rooms": 0, "surface": 0, "url": "https://www.newimmo.lu/fr/louer/appartement/bertrange/127171-appartement-bertrange/", "latitude": 49.61, "longitude": 6.05, "distance_km": 6.2, "created_at": "2026-02-20 20:05:02", "notified": 1}, {"id": 52, "listing_id": "athome_8919578", "site": "Athome.lu", "title": "L‚Äôappartement r√©nov√© en 2024 fait +/‚àí 100 m2 et il est situ√© au rez-de", "city": "Niederanven", "price": 2000, "rooms": 2, "surface": 0, "url": "https://www.athome.lu/location/appartement/niederanven/id-8919578.html", "latitude": 49.6524374, "longitude": 6.257763100000001, "distance_km": 10.6, "created_at": "2026-02-20 20:04:52", "notified": 1}, {"id": 51, "listing_id": "athome_8919970", "site": "Athome.lu", "title": "Abrigo propose en location un appartement spacieux et lumineux de 100 ", "city": "Junglinster", "price": 1950, "rooms": 5, "surface": 100, "url": "https://www.athome.lu/location/appartement/junglinster/id-8919970.html", "latitude": 49.7120944, "longitude": 6.2524317, "distance_km": 15.1, "created_at": "2026-02-20 20:04:42", "notified": 1}, {"id": 50, "listing_id": "athome_8600103", "site": "Athome.lu", "title": "L'agence immobili√®re MaraMax s.√†r.l vous propose en location ce spacie", "city": "Hautcharage", "price": 1980, "rooms": 2, "surface": 128, "url": "https://www.athome.lu/location/duplex/hautcharage/id-8600103.html", "latitude": 49.5756404, "longitude": 5.9086336, "distance_km": 16.5, "created_at": "2026-02-20 20:04:31", "notified": 1}, {"id": 49, "listing_id": "athome_8802259", "site": "Athome.lu", "title": "TOP : \r\n\r\n+++ APPARTEMENT AU 1re ETAGE +++\r\n\r\n*** Nous aimerions faire", "city": "Filsdorf", "price": 2350, "rooms": 3, "surface": 114, "url": "https://www.athome.lu/location/appartement/filsdorf/id-8802259.html", "latitude": 49.5341099, "longitude": 6.2474705, "distance_km": 11.0, "created_at": "2026-02-20 20:04:21", "notified": 1}, {"id": 48, "listing_id": "athome_8995712", "site": "Athome.lu", "title": "***Appartement enti√®rement meubl√© !***  \nSitu√© dans le quartier recher", "city": "Luxembourg-Weimerskirch", "price": 2100, "rooms": 2, "surface": 88, "url": "https://www.athome.lu/location/appartement/luxembourg-weimerskirch/id-8995712.html", "latitude": 49.6254273, "longitude": 6.135935, "distance_km": 2.8, "created_at": "2026-02-20 20:04:10", "notified": 1}, {"id": 47, "listing_id": "athome_8951940", "site": "Athome.lu", "title": "L'agence immobili√®re MaraMax s.√†r.l vous propose en location ce spacie", "city": "Hautcharage", "price": 1850, "rooms": 2, "surface": 92, "url": "https://www.athome.lu/location/appartement/hautcharage/id-8951940.html", "latitude": 49.5756404, "longitude": 5.9086336, "distance_km": 16.5, "created_at": "2026-02-20 20:04:00", "notified": 1}, {"id": 46, "listing_id": "athome_8980537", "site": "Athome.lu", "title": "Bel appartement √† 2 chambres √† louer au rez-de-chauss√©e de la r√©sidenc", "city": "Alzingen", "price": 2350, "rooms": 2, "surface": 80, "url": "https://www.athome.lu/location/appartement/alzingen/id-8980537.html", "latitude": 49.5712572, "longitude": 6.1637244, "distance_km": 3.8, "created_at": "2026-02-20 20:03:50", "notified": 1}, {"id": 45, "listing_id": "athome_8985065", "site": "Athome.lu", "title": "MANSO IMMO vous propose √† la location charmant appartement semi meubl√©", "city": "Bereldange", "price": 2100, "rooms": 2, "surface": 90, "url": "https://www.athome.lu/location/appartement/bereldange/id-8985065.html", "latitude": 49.6548632, "longitude": 6.1272733, "distance_km": 6.1, "created_at": "2026-02-20 20:03:39", "notified": 1}, {"id": 44, "listing_id": "athome_8990475", "site": "Athome.lu", "title": "Abrigo vous propose la location et la premi√®re occupation d'un apparte", "city": "Gonderange", "price": 2200, "rooms": 2, "surface": 95, "url": "https://www.athome.lu/location/appartement/gonderange/id-8990475.html", "latitude": 49.6938934, "longitude": 6.2498095, "distance_km": 13.4, "created_at": "2026-02-20 20:03:29", "notified": 1}, {"id": 43, "listing_id": "athome_8727519", "site": "Athome.lu", "title": "Appartement de haut standing, compl√®tement r√©nov√©, situ√© au 2√®me √©tage", "city": "Esch-sur-Alzette", "price": 2100, "rooms": 2, "surface": 91, "url": "https://www.athome.lu/location/appartement/esch-sur-alzette/id-8727519.html", "latitude": 49.502401, "longitude": 5.9721782, "distance_km": 15.9, "created_at": "2026-02-20 20:03:18", "notified": 1}, {"id": 42, "listing_id": "athome_8981863", "site": "Athome.lu", "title": "Bel appartement comprenant un hall d'entr√©e desservant un living avec ", "city": "Hassel", "price": 1850, "rooms": 2, "surface": 86, "url": "https://www.athome.lu/location/appartement/hassel/id-8981863.html", "latitude": 49.55093489999999, "longitude": 6.2076007, "distance_km": 7.6, "created_at": "2026-02-20 20:03:08", "notified": 1}, {"id": 41, "listing_id": "athome_8962425", "site": "Athome.lu", "title": "APPARTEMENT A LOUER AU 2E ETAGE: \r\n\r\nAPPARTEMENT 3 CHAMBRES A COUCHER ", "city": "Dudelange", "price": 2400, "rooms": 3, "surface": 92, "url": "https://www.athome.lu/location/appartement/dudelange/id-8962425.html", "latitude": 49.4800596, "longitude": 6.083069999999999, "distance_km": 13.8, "created_at": "2026-02-20 20:02:58", "notified": 1}, {"id": 40, "listing_id": "athome_8995617", "site": "Athome.lu", "title": "Situated in a quiet street in the sought-after neighborhood of Belair,", "city": "Luxembourg-Belair", "price": 2400, "rooms": 2, "surface": 95, "url": "https://www.athome.lu/location/appartement/luxembourg-belair/id-8995617.html", "latitude": 49.6097283, "longitude": 6.1092036, "distance_km": 2.1, "created_at": "2026-02-20 20:02:47", "notified": 1}, {"id": 39, "listing_id": "athome_8952053", "site": "Athome.lu", "title": "HomePass est ravis de vous pr√©senter ce magnifique appartement, id√©ale", "city": "Bertrange", "price": 2290, "rooms": 2, "surface": 80, "url": "https://www.athome.lu/location/appartement/bertrange/id-8952053.html", "latitude": 49.6084908, "longitude": 6.066778999999999, "distance_km": 4.9, "created_at": "2026-02-20 20:02:37", "notified": 1}, {"id": 38, "listing_id": "athome_8958134", "site": "Athome.lu", "title": "Luxembourg-Belair - Boulevard Pierre Dupong\n\nAppartement 2 chambres av", "city": "Luxembourg-Hollerich", "price": 2100, "rooms": 2, "surface": 80, "url": "https://www.athome.lu/location/appartement/luxembourg-hollerich/id-8958134.html", "latitude": 49.6023272, "longitude": 6.1137845, "distance_km": 1.5, "created_at": "2026-02-20 20:02:27", "notified": 1}, {"id": 37, "listing_id": "athome_8963275", "site": "Athome.lu", "title": "Alain Grossklos T√©l. : +352 691 265 450 vous propose √† la location ce ", "city": "Belvaux", "price": 2150, "rooms": 2, "surface": 105, "url": "https://www.athome.lu/location/appartement/belvaux/id-8963275.html", "latitude": 49.5085182, "longitude": 5.9368383, "distance_km": 17.5, "created_at": "2026-02-20 20:02:16", "notified": 1}, {"id": 36, "listing_id": "athome_8793493", "site": "Athome.lu", "title": "*** LOU√â ***\r\n\r\nDRP Group vous propose √† la location un tr√®s joli appa", "city": "Steinsel", "price": 2250, "rooms": 2, "surface": 85, "url": "https://www.athome.lu/location/appartement/steinsel/id-8793493.html", "latitude": 49.6750699, "longitude": 6.1377211, "distance_km": 8.4, "created_at": "2026-02-20 20:02:06", "notified": 1}, {"id": 35, "listing_id": "athome_8919659", "site": "Athome.lu", "title": "DALPA vous propose en location, ce lumineux appartement avec 2 chambre", "city": "Hesperange", "price": 2400, "rooms": 2, "surface": 85, "url": "https://www.athome.lu/location/appartement/hesperange/id-8919659.html", "latitude": 49.5731206, "longitude": 6.161307000000001, "distance_km": 3.6, "created_at": "2026-02-20 20:01:55", "notified": 1}, {"id": 34, "listing_id": "athome_8871260", "site": "Athome.lu", "title": "(English follows)\n\n√Ä louer Duplex lumineux avec terrasse privative\nApp", "city": "Luxembourg-Bonnevoie", "price": 2250, "rooms": 2, "surface": 95, "url": "https://www.athome.lu/location/duplex/luxembourg-bonnevoie/id-8871260.html", "latitude": 49.59625699999999, "longitude": 6.1366508, "distance_km": 0.5, "created_at": "2026-02-20 20:01:45", "notified": 1}, {"id": 33, "listing_id": "athome_8983182", "site": "Athome.lu", "title": "Bel appartement meubl√© de +/-82 m¬≤, situ√© au 4? √©tage avec ascenseur, ", "city": "Luxembourg-Bonnevoie", "price": 2100, "rooms": 4, "surface": 82, "url": "https://www.athome.lu/location/appartement/luxembourg-bonnevoie/id-8983182.html", "latitude": 49.6123327, "longitude": 6.125843199999999, "distance_km": 1.5, "created_at": "2026-02-20 20:01:35", "notified": 1}, {"id": 32, "listing_id": "athome_8952070", "site": "Athome.lu", "title": "Adresse : 14, rue Charles Darwin ‚Äì L-1433 Luxembourg\r\nSituation : en f", "city": "Luxembourg-Gasperich - Cloche d'or", "price": 2250, "rooms": 2, "surface": 82, "url": "https://www.athome.lu/location/appartement/luxembourg-gasperich---cloche-dor/id-8952070.html", "latitude": 49.5849, "longitude": 6.12475, "distance_km": 1.8, "created_at": "2026-02-20 20:01:24", "notified": 1}, {"id": 31, "listing_id": "athome_8994928", "site": "Athome.lu", "title": "Bel appartement √† louer au deuxi√®me √©tage dans une petite R√©sidence.\n\n", "city": "Luxembourg-Belair", "price": 2200, "rooms": 2, "surface": 90, "url": "https://www.athome.lu/location/appartement/luxembourg-belair/id-8994928.html", "latitude": 49.6073607, "longitude": 6.1155111, "distance_km": 1.6, "created_at": "2026-02-20 20:01:14", "notified": 1}, {"id": 30, "listing_id": "athome_7786123", "site": "Athome.lu", "title": "D√©marrez votre nouvelle vie √† Luxembourg avec ce confortable apparteme", "city": "Luxembourg-Gare", "price": 2390, "rooms": 3, "surface": 90, "url": "https://www.athome.lu/location/appartement/luxembourg-gare/id-7786123.html", "latitude": 49.599092, "longitude": 6.132617, "distance_km": 0.2, "created_at": "2026-02-20 20:01:03", "notified": 1}, {"id": 29, "listing_id": "athome_8812008", "site": "Athome.lu", "title": "Appartement 2 chambres enti√®rement r√©nov√© ? Luxembourg-Merl\n\nAdresse :", "city": "Luxembourg-Centre ville", "price": 2400, "rooms": 2, "surface": 80, "url": "https://www.athome.lu/location/appartement/luxembourg-centre-ville/id-8812008.html", "latitude": 49.6123327, "longitude": 6.1258432, "distance_km": 1.5, "created_at": "2026-02-20 20:00:53", "notified": 1}, {"id": 28, "listing_id": "athome_8995927", "site": "Athome.lu", "title": "Appartement moderne (047) de 2 chambres √† coucher, id√©alement situ√© pr", "city": "Luxembourg-Cessange", "price": 2375, "rooms": 2, "surface": 83, "url": "https://www.athome.lu/location/appartement/luxembourg-cessange/id-8995927.html", "latitude": 49.5889204, "longitude": 6.0994732, "distance_km": 2.8, "created_at": "2026-02-20 20:00:43", "notified": 1}, {"id": 27, "listing_id": "athome_8619057", "site": "Athome.lu", "title": "D√©marrez votre nouvelle vie √† Luxembourg avec ce charmant appartement ", "city": "Senningerberg", "price": 2340, "rooms": 2, "surface": 88, "url": "https://www.athome.lu/location/appartement/senningerberg/id-8619057.html", "latitude": 49.6450986, "longitude": 6.2223386, "distance_km": 8.1, "created_at": "2026-02-20 20:00:33", "notified": 1}, {"id": 26, "listing_id": "athome_8456918", "site": "Athome.lu", "title": "MT Real Estate Invest Sarl vous propose un superbe appartement √† louer", "city": "Luxembourg-Hollerich", "price": 2400, "rooms": 2, "surface": 80, "url": "https://www.athome.lu/location/appartement/luxembourg-hollerich/id-8456918.html", "latitude": 49.6022613, "longitude": 6.117406099999999, "distance_km": 1.2, "created_at": "2026-02-20 20:00:22", "notified": 1}, {"id": 25, "listing_id": "athome_8971769", "site": "Athome.lu", "title": "APPARTEMENT DUPLEX SPACIEUX A LOUER\nGrand Rue, L-3394 Roeser\n1er √©tage", "city": "Roeser", "price": 2300, "rooms": 2, "surface": 94, "url": "https://www.athome.lu/location/appartement/roeser/id-8971769.html", "latitude": 49.5398355, "longitude": 6.1444186, "distance_km": 6.7, "created_at": "2026-02-20 20:00:12", "notified": 1}, {"id": 24, "listing_id": "athome_8986750", "site": "Athome.lu", "title": "******** √Ä louer ? Bel appartement 2 chambres √† Bertrange ********\n\nSi", "city": "Bertrange", "price": 2200, "rooms": 5, "surface": 108, "url": "https://www.athome.lu/location/duplex/bertrange/id-8986750.html", "latitude": 49.6106248, "longitude": 6.0502349, "distance_km": 6.2, "created_at": "2026-02-20 20:00:01", "notified": 1}, {"id": 23, "listing_id": "athome_8871303", "site": "Athome.lu", "title": "A Louer - Superbe Appartement Moderne et Lumineux - 2 Chambres - Bertr", "city": "Bertrange", "price": 2400, "rooms": 6, "surface": 86, "url": "https://www.athome.lu/location/appartement/bertrange/id-8871303.html", "latitude": 49.6106248, "longitude": 6.0502349, "distance_km": 6.2, "created_at": "2026-02-20 19:59:51", "notified": 1}, {"id": 22, "listing_id": "athome_1719537", "site": "Athome.lu", "title": "Appartement, meubl√©, acc√®s facile, proche des institutions europ√©ennes", "city": "Senningerberg", "price": 2300, "rooms": 2, "surface": 100, "url": "https://www.athome.lu/location/appartement/senningerberg/id-1719537.html", "latitude": 49.64983, "longitude": 6.22619, "distance_km": 8.6, "created_at": "2026-02-20 19:59:40", "notified": 1}, {"id": 21, "listing_id": "athome_7981264", "site": "Athome.lu", "title": "Senningerberg - Proximit√© imm√©diate a√©roport & Kirchberg\r\n\r\nA louer ap", "city": "Senningerberg", "price": 1950, "rooms": 2, "surface": 90, "url": "https://www.athome.lu/location/appartement/senningerberg/id-7981264.html", "latitude": 49.6508207, "longitude": 6.2352602, "distance_km": 9.2, "created_at": "2026-02-20 19:59:30", "notified": 1}, {"id": 20, "listing_id": "athome_8992071", "site": "Athome.lu", "title": "A louer lumineux appartement deux chambres √† Sprinkange.\r\n\r\nCet appart", "city": "Sprinkange", "price": 2100, "rooms": 2, "surface": 90, "url": "https://www.athome.lu/location/appartement/sprinkange/id-8992071.html", "latitude": 49.5842339, "longitude": 5.9640686, "distance_km": 12.4, "created_at": "2026-02-20 19:59:20", "notified": 1}, {"id": 19, "listing_id": "athome_8899869", "site": "Athome.lu", "title": "Superbe duplex de 98,78 m¬≤ situ√© √† Garnich, Luxembourg, est une opport", "city": "Garnich", "price": 2400, "rooms": 2, "surface": 98, "url": "https://www.athome.lu/location/duplex/garnich/id-8899869.html", "latitude": 49.6174427, "longitude": 5.9512695, "distance_km": 13.3, "created_at": "2026-02-20 19:59:09", "notified": 1}, {"id": 18, "listing_id": "athome_8939499", "site": "Athome.lu", "title": "A louer bel appartement deux chambres √† Luxembourg-Kirchberg. \r\n\r\nCet ", "city": "Luxembourg-Kirchberg", "price": 2350, "rooms": 2, "surface": 87, "url": "https://www.athome.lu/location/appartement/luxembourg-kirchberg/id-8939499.html", "latitude": 49.6251297, "longitude": 6.1426854, "distance_km": 2.9, "created_at": "2026-02-20 19:58:59", "notified": 1}, {"id": 17, "listing_id": "athome_8971656", "site": "Athome.lu", "title": "Appartement de haut standing lumineux avec jardin privatif sis au rez-", "city": "Bridel", "price": 2100, "rooms": 3, "surface": 85, "url": "https://www.athome.lu/location/appartement/bridel/id-8971656.html", "latitude": 49.6576485, "longitude": 6.0817229, "distance_km": 7.4, "created_at": "2026-02-20 19:58:49", "notified": 1}, {"id": 16, "listing_id": "nextimmo_12392", "site": "Nextimmo.lu", "title": "Appartement Bridel", "city": "Bridel", "price": 2400, "rooms": 3, "surface": 100, "url": "https://nextimmo.lu/en/details/12392", "latitude": 49.655, "longitude": 6.08, "distance_km": 7.3, "created_at": "2026-02-20 19:58:38", "notified": 1}, {"id": 15, "listing_id": "athome_8086234", "site": "Athome.lu", "title": "Many Many vous propose cet appartement de 98 m¬≤, situ√© au 2√®me √©tage d", "city": "Belval", "price": 2375, "rooms": 2, "surface": 98, "url": "https://www.athome.lu/location/appartement/belval/id-8086234.html", "latitude": 49.5045503, "longitude": 5.9435467, "distance_km": 17.4, "created_at": "2026-02-20 19:58:28", "notified": 1}, {"id": 14, "listing_id": "athome_8976000", "site": "Athome.lu", "title": "A louer, superbe appartement de 89 m2 avec 2 chambres √† coucher, parti", "city": "Bertrange", "price": 2300, "rooms": 2, "surface": 89, "url": "https://www.athome.lu/location/appartement/bertrange/id-8976000.html", "latitude": 49.6024772, "longitude": 6.0732987, "distance_km": 4.4, "created_at": "2026-02-20 19:58:18", "notified": 1}, {"id": 13, "listing_id": "athome_8114963", "site": "Athome.lu", "title": "Many Many vous propose ce bel appartement rez-de-Jardin de 81 m¬≤ situ√©", "city": "Luxembourg-Bonnevoie", "price": 2300, "rooms": 2, "surface": 81, "url": "https://www.athome.lu/location/appartement/luxembourg-bonnevoie/id-8114963.html", "latitude": 49.5923442, "longitude": 6.1441177, "distance_km": 1.1, "created_at": "2026-02-20 19:58:07", "notified": 1}, {"id": 12, "listing_id": "athome_8221893", "site": "Athome.lu", "title": "++++COUP DE COEUR! FULLY FURNISHED COLOCATION POSSIBLE AVAILABLE 15.06", "city": "Esch-sur-Alzette", "price": 1750, "rooms": 2, "surface": 90, "url": "https://www.athome.lu/location/appartement/esch-sur-alzette/id-8221893.html", "latitude": 49.4964624, "longitude": 5.9753139, "distance_km": 16.2, "created_at": "2026-02-20 19:57:57", "notified": 1}, {"id": 11, "listing_id": "athome_7980446", "site": "Athome.lu", "title": "+++SHORT TERM COURT SEJOUR FULLY FURNISHED+++EUREKA REAL ESTATE vous p", "city": "Luxembourg-Kirchberg", "price": 2400, "rooms": 2, "surface": 80, "url": "https://www.athome.lu/location/appartement/luxembourg-kirchberg/id-7980446.html", "latitude": 49.6278694, "longitude": 6.153422, "distance_km": 3.4, "created_at": "2026-02-20 19:57:47", "notified": 1}, {"id": 10, "listing_id": "athome_8984620", "site": "Athome.lu", "title": "Groupe Iris Immobilier S.A. est ravi de vous proposer ce bel apparteme", "city": "Belvaux", "price": 2050, "rooms": 5, "surface": 80, "url": "https://www.athome.lu/location/appartement/belvaux/id-8984620.html", "latitude": 49.5044913, "longitude": 5.9418997, "distance_km": 17.5, "created_at": "2026-02-20 19:57:36", "notified": 1}, {"id": 9, "listing_id": "athome_8994521", "site": "Athome.lu", "title": "appartement lumineux sis au rez-de-chauss√©e sur√©lev√© d‚Äôun petit immeub", "city": "Luxembourg-Belair", "price": 2250, "rooms": 5, "surface": 90, "url": "https://www.athome.lu/location/appartement/luxembourg-belair/id-8994521.html", "latitude": 49.6078954, "longitude": 6.1070622, "distance_km": 2.1, "created_at": "2026-02-20 19:57:26", "notified": 1}, {"id": 8, "listing_id": "athome_8983034", "site": "Athome.lu", "title": "Spacieux appartement sis au rez-de-chauss√©e, dans une R√©sidence tr√®s s", "city": "Rollingen", "price": 2150, "rooms": 6, "surface": 100, "url": "https://www.athome.lu/location/appartement/rollingen/id-8983034.html", "latitude": 49.7402205, "longitude": 6.1137785, "distance_km": 15.7, "created_at": "2026-02-20 19:57:16", "notified": 1}, {"id": 7, "listing_id": "athome_8982958", "site": "Athome.lu", "title": "Spacieux triplex en situation calme √† Brouch, offrant des espaces g√©n√©", "city": "Brouch (Mersch)", "price": 2400, "rooms": 3, "surface": 172, "url": "https://www.athome.lu/location/duplex/brouch-(mersch)/id-8982958.html", "latitude": 49.7373735, "longitude": 6.0202389, "distance_km": 17.3, "created_at": "2026-02-20 19:57:05", "notified": 1}, {"id": 6, "listing_id": "athome_8971722", "site": "Athome.lu", "title": "Lien vers visite virtuelle : https://tour.giraffe360.com/0b04f7ad1b0a4", "city": "Luxembourg-Centre Ville", "price": 2350, "rooms": 2, "surface": 93, "url": "https://www.athome.lu/location/appartement/luxembourg-centre-ville/id-8971722.html", "latitude": 49.6118458, "longitude": 6.126972500000001, "distance_km": 1.4, "created_at": "2026-02-20 19:56:55", "notified": 1}, {"id": 5, "listing_id": "athome_8958851", "site": "Athome.lu", "title": "Situ√© dans le paisible village de Contern, dans une r√©sidence avec asc", "city": "Contern", "price": 2400, "rooms": 2, "surface": 82, "url": "https://www.athome.lu/location/appartement/contern/id-8958851.html", "latitude": 49.5854461, "longitude": 6.224731299999999, "distance_km": 6.7, "created_at": "2026-02-20 19:56:45", "notified": 1}, {"id": 4, "listing_id": "immotop_1847365", "site": "Immotop.lu", "title": "Appartement 2 chambres rez-de-chauss√©e, Gare, Luxembourg", "city": "Luxembourg", "price": 2000, "rooms": 2, "surface": 0, "url": "https://www.immotop.lu/annonces/1847365/", "latitude": 49.6116, "longitude": 6.1319, "distance_km": 1.3, "created_at": "2026-02-20 19:56:34", "notified": 1}, {"id": 3, "listing_id": "immotop_1872303", "site": "Immotop.lu", "title": "Appartement 2 chambres 2, Rue Jean-Jacques Rousseau, Belval Sud-Lyc√©e,", "city": "Sanem", "price": 2050, "rooms": 2, "surface": 0, "url": "https://www.immotop.lu/annonces/1872303/", "latitude": 49.55, "longitude": 5.98, "distance_km": 12.4, "created_at": "2026-02-20 19:56:24", "notified": 1}, {"id": 2, "listing_id": "immotop_1875939", "site": "Immotop.lu", "title": "Appartement 2 chambres rue Antoine Meyer, Hollerich, Luxembourg", "city": "Luxembourg", "price": 2200, "rooms": 2, "surface": 0, "url": "https://www.immotop.lu/annonces/1875939/", "latitude": 49.6116, "longitude": 6.1319, "distance_km": 1.3, "created_at": "2026-02-20 19:56:13", "notified": 1}, {"id": 1, "listing_id": "nextimmo_86702812", "site": "Nextimmo.lu", "title": "Appartement Mamer", "city": "Mamer", "price": 2000, "rooms": 2, "surface": 81, "url": "https://nextimmo.lu/en/details/86702812", "latitude": 49.62391, "longitude": 6.01063, "distance_km": 9.3, "created_at": "2026-02-20 19:56:08", "notified": 1}];
let filtered = [...ALL];
let cmpSet = new Set();
let dt, mapObj, clusterGroup = null;

const SITE_COLORS = {
  'Athome.lu':'bg-primary','Immotop.lu':'bg-success','Luxhome.lu':'bg-info text-dark',
  'VIVI.lu':'bg-warning text-dark','Nextimmo.lu':'bg-secondary','Newimmo.lu':'bg-danger',
  'Unicorn.lu':'bg-dark','Remax.lu':'bg-success'
};

window.addEventListener('DOMContentLoaded', () => { initMap(); render(ALL); });

function fmt(n) { return n != null ? Number(n).toLocaleString('fr-FR') : '‚Äî'; }
function trunc(s,n) { return s && s.length>n ? s.slice(0,n)+'‚Ä¶' : (s||'‚Äî'); }
function dBadge(d) {
  if(d==null) return 'bg-secondary';
  return d<2?'bg-success':d<5?'bg-primary':d<10?'bg-warning text-dark':'bg-danger';
}
function dColor(d) {
  if(d==null) return '#6c757d';
  return d<2?'#198754':d<5?'#0d6efd':d<10?'#ffc107':'#dc3545';
}

function render(data) {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  data.forEach(l => {
    const pm2 = (l.price>0&&l.surface>0) ? Math.round(l.price/l.surface*10)/10 : '';
    const dist = l.distance_km!=null
      ? `<span class="badge ${dBadge(l.distance_km)}">${l.distance_km.toFixed(1)} km</span>`
      : '<span class="text-muted small">‚Äî</span>';
    const site = l.site||'‚Äî';
    const sc = SITE_COLORS[site]||'bg-secondary';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="cchk" value="${l.id}" onchange="togCmp(${l.id},this)"></td>
      <td><span class="badge ${sc} badge-site">${site}</span></td>
      <td>${l.city||'‚Äî'}</td>
      <td class="fw-bold">${l.price?fmt(l.price)+' ‚Ç¨':'‚Äî'}</td>
      <td>${l.surface||'‚Äî'}</td>
      <td class="pm2">${pm2?pm2+' ‚Ç¨':'‚Äî'}</td>
      <td>${l.rooms||'‚Äî'}</td>
      <td>${dist}</td>
      <td><a class="al" href="${l.url}" target="_blank" title="${l.title}">${trunc(l.title,55)}</a></td>
      <td class="text-muted small">${l.created_at?l.created_at.slice(0,10):'‚Äî'}</td>
      <td class="text-center">${l.notified?'‚úÖ':''}</td>`;
    tbody.appendChild(tr);
  });
  if(dt) { dt.destroy(); }
  dt = $('#tbl').DataTable({
    paging:true, pageLength:25, ordering:true, order:[[3,'asc']], searching:true,
    language:{ url:'https://cdn.datatables.net/plug-ins/1.13.8/i18n/fr-FR.json' },
    columnDefs:[{ orderable:false, targets:[0,8] }]
  });
  document.getElementById('chk-all').checked = false;
  const rc = document.getElementById('result-count');
  if(rc) rc.textContent = `${data.length} annonce${data.length>1?'s':''} affich√©e${data.length>1?'s':''}`;
  updateMap(data);
}

function applyFilters() {
  const sites  = [...document.getElementById('f-site').selectedOptions].map(o=>o.value).filter(v=>v);
  const cities = [...document.getElementById('f-city').selectedOptions].map(o=>o.value).filter(v=>v);
  const pmin   = parseFloat(document.getElementById('f-pmin').value)||0;
  const pmax   = parseFloat(document.getElementById('f-pmax').value)||Infinity;
  const smin   = parseFloat(document.getElementById('f-smin').value)||0;
  const rooms  = document.getElementById('f-rooms').value;
  const dmax   = parseFloat(document.getElementById('f-dmax').value)||Infinity;
  const notif  = document.getElementById('f-notif').value;
  filtered = ALL.filter(l => {
    if(sites.length  && !sites.includes(l.site))  return false;
    if(cities.length && !cities.includes(l.city)) return false;
    if(l.price<pmin || l.price>pmax) return false;
    if(smin>0 && l.surface>0 && l.surface<smin) return false;
    if(rooms) { if(rooms==='4'){if(l.rooms<4)return false;} else{if(l.rooms&&l.rooms!=+rooms)return false;} }
    if(dmax<Infinity && l.distance_km!=null && l.distance_km>dmax) return false;
    if(notif==='1' && !l.notified) return false;
    if(notif==='0' && l.notified)  return false;
    return true;
  });
  render(filtered);
}

function resetFilters() {
  ['f-site','f-city'].forEach(id=>{ document.getElementById(id).selectedIndex=-1; });
  ['f-pmin','f-pmax','f-smin','f-dmax'].forEach(id=>{ document.getElementById(id).value=''; });
  document.getElementById('f-rooms').value='';
  document.getElementById('f-notif').value='';
  filtered=[...ALL]; render(filtered);
}

function initMap() {
  mapObj = L.map('map').setView([49.6116,6.1319],11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    {attribution:'¬© OpenStreetMap contributors', maxZoom:19}).addTo(mapObj);
  updateMap(ALL);
}

function updateMap(data) {
  if(clusterGroup) { mapObj.removeLayer(clusterGroup); }
  clusterGroup = L.markerClusterGroup({
    maxClusterRadius: 40,
    iconCreateFunction: function(cluster) {
      const n = cluster.getChildCount();
      const sz = n < 10 ? 32 : n < 50 ? 40 : 48;
      return L.divIcon({
        html: `<div style="background:#0d6efd;color:#fff;border-radius:50%;width:${sz}px;height:${sz}px;
          display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;
          box-shadow:0 2px 6px rgba(0,0,0,.35);border:2px solid #fff;">${n}</div>`,
        iconSize: [sz, sz], iconAnchor: [sz/2, sz/2], className: ''
      });
    }
  });

  let geoCount = 0;
  const bounds = [];
  data.forEach(l => {
    if(!l.latitude || !l.longitude) return;
    geoCount++;
    bounds.push([l.latitude, l.longitude]);
    const col  = dColor(l.distance_km);
    const pm2  = (l.price>0&&l.surface>0) ? Math.round(l.price/l.surface) : null;
    const icon = L.divIcon({
      html: `<div style="background:${col};width:14px;height:14px;border-radius:50%;
        border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.4);"></div>`,
      iconSize:[14,14], iconAnchor:[7,7], className:''
    });
    const popup = `
      <div style="min-width:200px;font-size:.85rem">
        <div style="font-weight:700;margin-bottom:4px">${l.city||''}</div>
        <div style="font-size:1rem;color:#0d6efd;font-weight:600">${l.price?fmt(l.price)+' ‚Ç¨':'‚Äî'}</div>
        <div class="text-muted" style="font-size:.78rem">
          ${l.surface?l.surface+' m¬≤':''}
          ${l.rooms?'¬∑ '+l.rooms+' ch':''}
          ${pm2?'¬∑ '+pm2+' ‚Ç¨/m¬≤':''}
        </div>
        ${l.distance_km!=null?'<div style="font-size:.78rem;color:#666">'+l.distance_km.toFixed(1)+' km du centre</div>':''}
        <div style="margin-top:6px;font-size:.78rem;color:#555">${trunc(l.title,60)}</div>
        <div style="margin-top:6px"><a href="${l.url}" target="_blank" class="btn btn-sm btn-outline-primary py-0 px-2">Voir l'annonce ‚Üí</a></div>
        <div style="font-size:.72rem;color:#999;margin-top:4px">${l.site||''}</div>
      </div>`;
    L.marker([l.latitude, l.longitude], {icon}).bindPopup(popup).addTo(clusterGroup);
  });

  clusterGroup.addTo(mapObj);

  // Adapter le zoom pour afficher tous les markers
  if(bounds.length > 0) {
    try { mapObj.fitBounds(bounds, {padding:[30,30], maxZoom:13}); } catch(e) {}
  }

  // Compteur sur la carte
  const mc = document.getElementById('map-count');
  if(mc) mc.textContent = geoCount;
}

function togCmp(id,chk) {
  chk.checked ? cmpSet.add(id) : cmpSet.delete(id);
  const btn=document.getElementById('compare-btn');
  document.getElementById('cmp-cnt').textContent=cmpSet.size;
  btn.style.display=cmpSet.size>=2?'inline-block':'none';
}
function toggleAll(chk) {
  document.querySelectorAll('.cchk').forEach(c=>{
    c.checked=chk.checked; chk.checked?cmpSet.add(+c.value):cmpSet.delete(+c.value);
  });
  document.getElementById('cmp-cnt').textContent=cmpSet.size;
  document.getElementById('compare-btn').style.display=cmpSet.size>=2?'inline-block':'none';
}
function openCompare() {
  const sel=ALL.filter(l=>cmpSet.has(l.id));
  if(sel.length<2) return;
  const fields=[
    ['Site',l=>l.site||'‚Äî'],['Ville',l=>l.city||'‚Äî'],
    ['Prix',l=>l.price?fmt(l.price)+' ‚Ç¨':'‚Äî'],
    ['Surface',l=>l.surface?l.surface+' m¬≤':'‚Äî'],
    ['‚Ç¨/m¬≤',l=>(l.price&&l.surface)?Math.round(l.price/l.surface*10)/10+' ‚Ç¨':'‚Äî'],
    ['Pi√®ces',l=>l.rooms||'‚Äî'],
    ['Distance',l=>l.distance_km!=null?l.distance_km.toFixed(1)+' km':'‚Äî'],
    ['Notifi√©',l=>l.notified?'‚úÖ':'‚ùå'],
    ['Date',l=>l.created_at?l.created_at.slice(0,10):'‚Äî'],
    ['Lien',l=>`<a href="${l.url}" target="_blank">Voir</a>`],
  ];
  let html='<table class="table table-sm table-bordered"><thead class="table-dark"><tr><th>Crit√®re</th>';
  sel.forEach(l=>{html+=`<th>${trunc(l.title,30)}</th>`;});
  html+='</tr></thead><tbody>';
  fields.forEach(([lbl,fn])=>{
    html+=`<tr><td class="fw-semibold">${lbl}</td>`;
    sel.forEach(l=>{html+=`<td>${fn(l)}</td>`;});
    html+='</tr>';
  });
  html+='</tbody></table>';
  document.getElementById('cmp-body').innerHTML=html;
  new bootstrap.Modal(document.getElementById('cmp-modal')).show();
}
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js')
    .then(() => console.log('PWA: Service Worker actif'))
    .catch(e  => console.warn('PWA: SW non enregistre', e));
}
</script>
</body>
</html>