<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
    <title>ImmoLux Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
    <style>
        :root { --primary: #667eea; --primary-dark: #5a6fd6; }
        * { -webkit-tap-highlight-color: transparent; }
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 2rem; }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 1.2rem 1rem; margin-bottom: 1rem;
            position: sticky; top: 0; z-index: 1000;
        }
        .header h1 { font-size: 1.4rem; margin: 0; }
        .header small { opacity: 0.8; font-size: 0.75rem; }

        .stat-card {
            background: white; border-radius: 12px; padding: 0.8rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center;
        }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        .card { border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card-header { background: white; border-bottom: 2px solid #f0f2f5; font-weight: 600; }

        .nav-tabs { position: sticky; top: 60px; z-index: 999; background: #f0f2f5; padding-top: 0.5rem; }
        .nav-tabs .nav-link { color: #666; font-weight: 500; font-size: 0.9rem; }
        .nav-tabs .nav-link.active { color: var(--primary); border-color: var(--primary); }

        .site-badge {
            display: inline-block; padding: 2px 8px; border-radius: 12px;
            color: white; font-size: 0.7rem; font-weight: 600;
        }

        .table { font-size: 0.8rem; }
        .table th { cursor: pointer; user-select: none; white-space: nowrap; font-size: 0.75rem; }
        .table th:hover { background: #e9ecef; }
        .table td { vertical-align: middle; }
        .sort-arrow { opacity: 0.3; margin-left: 2px; }
        .sort-arrow.active { opacity: 1; }

        .filter-section { background: white; border-radius: 12px; padding: 0.8rem 1rem; margin-bottom: 0.8rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

        .city-group { background: white; border-radius: 12px; padding: 1rem; margin-bottom: 0.8rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .city-group h5 { color: var(--primary); margin-bottom: 0.6rem; font-size: 1rem; }

        .price-range-section { background: white; border-radius: 12px; padding: 1rem; margin-bottom: 0.8rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .price-range-section h5 { margin-bottom: 0.6rem; font-size: 1rem; }
        .price-badge { font-size: 0.8rem; padding: 3px 10px; border-radius: 8px; }

        #map { height: 350px; border-radius: 12px; }

        a { color: var(--primary); text-decoration: none; }
        a:hover { text-decoration: underline; }
        .listing-count { font-size: 0.8rem; color: #888; }

        /* üìä Qualit√© des donn√©es */
        .quality-badge { padding: 5px 15px; border-radius: 20px; font-weight: 600; }
        .quality-bar { height: 8px; border-radius: 4px; background: #e9ecef; margin-top: 5px; overflow: hidden; }
        .quality-fill { height: 100%; background: #2ECC71; transition: width 0.3s; }

        /* üö® Anomalies */
        .anomaly-alert { background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .anomaly-item { font-size: 0.8rem; color: #856404; }
        .flag-badge { display: inline-block; font-size: 0.6rem; padding: 2px 6px; border-radius: 3px; margin-right: 3px; }
        .flag-suspect { background: #FF6384; color: white; }
        .flag-eleve { background: #FFA500; color: white; }
        .flag-petite { background: #36A2EB; color: white; }
        .flag-gps { background: #999; color: white; }

        /* üì± Timeline */
        .timeline-slider { width: 100%; height: 40px; padding: 10px 0; }
        .timeline-label { font-size: 0.75rem; color: #666; margin-top: 5px; }

        /* üîó QR Codes & Partage */
        .qr-modal { text-align: center; }
        .qr-image { max-width: 200px; border: 1px solid #ddd; padding: 10px; border-radius: 8px; }
        .share-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .share-btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; color: white; text-decoration: none; transition: all 0.2s; }
        .share-btn:hover { transform: scale(1.1); }
        .share-whatsapp { background: #25D366; }
        .share-telegram { background: #0088cc; }
        .share-email { background: #EA4335; }

        /* üó∫Ô∏è Map Mode Buttons */
        #map-mode-markers.active, #map-mode-heatmap.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* üó∫Ô∏è Heatmap prix */
        .heatmap-legend { background: white; padding: 10px; border-radius: 5px; font-size: 0.8rem; }
        .heatmap-entry { display: flex; align-items: center; gap: 8px; margin: 5px 0; }
        .heatmap-color { width: 20px; height: 15px; border-radius: 3px; }

        /* Mobile */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.1rem; }
            .stat-value { font-size: 1.2rem; }
            .stat-label { font-size: 0.6rem; }
            .table { font-size: 0.7rem; }
            .container-fluid { padding-left: 0.5rem; padding-right: 0.5rem; }
            #map { height: 280px; }
            .share-buttons { flex-wrap: wrap; }
        }
    </style>
</head>
<body>

<!-- Header avec Navigation -->
<div class="header">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <h1>ImmoLux Dashboard v2.0</h1>
            <small>Mis a jour le 25/02/2026 19:52 ‚Äî 143 annonces</small>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <a href="index.html" style="color: white; text-decoration: none; font-weight: 500;">üìä Dashboard</a>
            <a href="map.html" style="color: white; text-decoration: none; font-weight: 500;">üó∫Ô∏è Carte</a>
            <a href="photos.html" style="color: white; text-decoration: none; font-weight: 500;">üñºÔ∏è Photos</a>
        </div>
    </div>
    <div class="d-flex justify-content-between align-items-center">
        <div style="margin-top: 8px;">
            <span class="quality-badge" style="background: #2ECC71; color: white;">
                üìä Qualit√©: 95%
            </span>
            
        </div>
        <div>
            <span class="listing-count">77 villes | 6 sites | GPS: 136/143</span>
        </div>
    </div>
</div>

<div class="container-fluid px-3">

    <!-- Stats -->
    <div class="row g-2 mb-3">
        <div class="col-4 col-md-2">
            <div class="stat-card">
                <div class="stat-value">143</div>
                <div class="stat-label">Annonces</div>
            </div>
        </div>
        <div class="col-4 col-md-2">
            <div class="stat-card">
                <div class="stat-value">2096&euro;</div>
                <div class="stat-label">Prix moy.</div>
            </div>
        </div>
        <div class="col-4 col-md-2">
            <div class="stat-card">
                <div class="stat-value">1300&euro;</div>
                <div class="stat-label">Min</div>
            </div>
        </div>
        <div class="col-4 col-md-2">
            <div class="stat-card">
                <div class="stat-value">2500&euro;</div>
                <div class="stat-label">Max</div>
            </div>
        </div>
        <div class="col-4 col-md-2">
            <div class="stat-card">
                <div class="stat-value">104m&sup2;</div>
                <div class="stat-label">Surface</div>
            </div>
        </div>
        <div class="col-4 col-md-2">
            <div class="stat-card">
                <div class="stat-value">77</div>
                <div class="stat-label">Villes</div>
            </div>
        </div>
    </div>

    <!-- Par site -->
    <div class="filter-section mb-2">
        <strong>Sites :</strong>
        <span class="site-badge ms-1" style="background:#FF6384">SothebysRealty.lu (5)</span> <span class="site-badge ms-1" style="background:#36A2EB">VIVI.lu (8)</span> <span class="site-badge ms-1" style="background:#FFCE56">Athome.lu (96)</span> <span class="site-badge ms-1" style="background:#4BC0C0">Immotop.lu (4)</span> <span class="site-badge ms-1" style="background:#9966FF">Nextimmo.lu (25)</span> <span class="site-badge ms-1" style="background:#FF9F40">Newimmo.lu (5)</span>
    </div>

    <!-- Onglets v2.0 -->
    <ul class="nav nav-tabs mb-2" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-table">üìã Tableau</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-site">üìä Sites</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-city">üìç Villes</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-price">üí∞ Par prix</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-map">üó∫Ô∏è Carte</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-heatmap">üî• Densit√©</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-timeline">üìà Timeline</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-anomalies">üö® Anomalies</button>
        </li>
    </ul>

    <div class="tab-content">

        <!-- TAB: Tableau -->
        <div class="tab-pane fade show active" id="tab-table">
            <div class="filter-section">
                <div class="row g-2 align-items-end">
                    <div class="col-6 col-md-3">
                        <label class="form-label form-label-sm mb-0">Ville</label>
                        <select id="f-city" class="form-select form-select-sm"><option value="">Toutes</option></select>
                    </div>
                    <div class="col-3 col-md-2">
                        <label class="form-label form-label-sm mb-0">Prix min</label>
                        <input type="number" id="f-pmin" class="form-control form-control-sm" placeholder="0">
                    </div>
                    <div class="col-3 col-md-2">
                        <label class="form-label form-label-sm mb-0">Prix max</label>
                        <input type="number" id="f-pmax" class="form-control form-control-sm" placeholder="9999">
                    </div>
                    <div class="col-6 col-md-2">
                        <label class="form-label form-label-sm mb-0">Site</label>
                        <select id="f-site" class="form-select form-select-sm"><option value="">Tous</option></select>
                    </div>
                    <div class="col-3 col-md-2">
                        <label class="form-label form-label-sm mb-0">m&sup2; min</label>
                        <input type="number" id="f-smin" class="form-control form-control-sm" placeholder="0">
                    </div>
                    <div class="col-3 col-md-1">
                        <button class="btn btn-sm btn-outline-secondary w-100" onclick="resetFilters()">Reset</button>
                    </div>
                </div>
            </div>
            <div class="card mt-2">
                <div class="card-header d-flex justify-content-between py-2">
                    <span>Annonces</span>
                    <span id="table-count" class="listing-count"></span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="main-table">
                        <thead>
                            <tr>
                                <th data-col="site">Site <span class="sort-arrow">&#9650;</span></th>
                                <th data-col="city">Ville <span class="sort-arrow">&#9650;</span></th>
                                <th data-col="price">Prix <span class="sort-arrow">&#9650;</span></th>
                                <th data-col="rooms">Ch. <span class="sort-arrow">&#9650;</span></th>
                                <th data-col="surface">m&sup2; <span class="sort-arrow">&#9650;</span></th>
                                <th data-col="price_m2">&euro;/m&sup2; <span class="sort-arrow">&#9650;</span></th>
                                <th data-col="distance_km">Dist. <span class="sort-arrow">&#9650;</span></th>
                                <th>Titre</th>
                                <th style="width: 80px;">Partage</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: Par ville -->
        <div class="tab-pane fade" id="tab-city">
            <div class="card mb-3">
                <div class="card-header">üìä Graphique par ville</div>
                <div class="card-body">
                    <canvas id="cityChart" height="80"></canvas>
                </div>
            </div>
            <div id="city-container"></div>
        </div>

        <!-- TAB: Par site -->
        <div class="tab-pane fade" id="tab-site">
            <div class="card mb-3">
                <div class="card-header">üìä R√©partition par site</div>
                <div class="card-body">
                    <canvas id="siteChart" height="80"></canvas>
                </div>
            </div>
        </div>

        <!-- TAB: Par prix -->
        <div class="tab-pane fade" id="tab-price">
            <div id="price-container"></div>
        </div>

        <!-- TAB: Carte -->
        <div class="tab-pane fade" id="tab-map">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>üìç Carte des annonces</span>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" id="map-mode-markers">üìç Markers</button>
                        <button class="btn btn-sm btn-outline-secondary" id="map-mode-heatmap">üî• Heatmap</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="height: 400px;"></div>
                </div>
            </div>
        </div>

        <!-- TAB: Heatmap Densit√© üî• -->
        <div class="tab-pane fade" id="tab-heatmap">
            <div class="card">
                <div class="card-header">
                    <span>üî• Heatmap de densit√© des annonces</span>
                    <small class="float-end">Plus sombre = plus d'annonces</small>
                </div>
                <div class="card-body p-0">
                    <div id="heatmap" style="height: 400px;"></div>
                </div>
            </div>
        </div>

        <!-- TAB: Timeline üìà -->
        <div class="tab-pane fade" id="tab-timeline">
            <div class="card">
                <div class="card-header">üìà Timeline des annonces</div>
                <div class="card-body">
                    <div class="timeline-slider">
                        <input type="range" id="timeline-slider" style="width: 100%;" min="0" max="100">
                        <div class="timeline-label">
                            <strong id="timeline-date">Toutes les dates</strong> - <span id="timeline-count">Chargement...</span>
                        </div>
                    </div>
                    <canvas id="timelineChart" style="margin-top: 20px;"></canvas>
                </div>
            </div>
        </div>

        <!-- TAB: Anomalies üö® -->
        <div class="tab-pane fade" id="tab-anomalies">
            <div class="card">
                <div class="card-header">üö® Anomalies d√©tect√©es</div>
                <div class="card-body">
                    <div id="anomalies-container">
                        <p class="text-muted">Analyse en cours...</p>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="data/listings.js"></script>
<script src="data/stats.js"></script>
<script>

// --- Utilitaires ---
function fmt(n) { return n ? n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ') : '‚Äî'; }
function badge(site) {
    const bg = SITE_COLORS[site] || '#888';
    return `<span class="site-badge" style="background:${bg}">${site}</span>`;
}

// --- Tableau triable ---
let sortCol = 'price';
let sortAsc = true;
let filtered = []; // Sera rempli par waitForDataAndInit() quand LISTINGS sera charg√©

function applyFilters() {
    const city = document.getElementById('f-city').value;
    const pmin = parseInt(document.getElementById('f-pmin').value) || 0;
    const pmax = parseInt(document.getElementById('f-pmax').value) || 999999;
    const site = document.getElementById('f-site').value;
    const smin = parseInt(document.getElementById('f-smin').value) || 0;

    filtered = LISTINGS.filter(l => {
        if (city && l.city !== city) return false;
        if (l.price < pmin || l.price > pmax) return false;
        if (site && l.site !== site) return false;
        if (smin && (!l.surface || l.surface < smin)) return false;
        return true;
    });
    sortAndRender();
    updateMap();
}

function sortAndRender() {
    filtered.sort((a, b) => {
        let va = a[sortCol], vb = b[sortCol];
        if (va == null) va = sortAsc ? Infinity : -Infinity;
        if (vb == null) vb = sortAsc ? Infinity : -Infinity;
        if (typeof va === 'string') return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
        return sortAsc ? va - vb : vb - va;
    });
    renderTable();
}

function renderTable() {
    const tbody = document.getElementById('table-body');
    document.getElementById('table-count').textContent = filtered.length + ' / ' + LISTINGS.length;
    if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-3">Aucune annonce</td></tr>';
        return;
    }
    tbody.innerHTML = filtered.map(l => `
        <tr>
            <td>${badge(l.site)}</td>
            <td>${l.city || '‚Äî'}</td>
            <td><strong>${fmt(l.price)}&euro;</strong></td>
            <td>${l.rooms || '‚Äî'}</td>
            <td>${l.surface || '‚Äî'}</td>
            <td>${l.price_m2 ? l.price_m2 + '&euro;' : '‚Äî'}</td>
            <td>${l.distance_km != null ? l.distance_km + ' km' : '‚Äî'}</td>
            <td><a href="${l.url}" target="_blank">${(l.title || 'Voir').substring(0, 50)}</a></td>
            <td>
                <div class="share-buttons" style="gap: 4px;">
                    <a href="${l.share_urls.whatsapp}" target="_blank" class="share-btn share-whatsapp" title="WhatsApp">üí¨</a>
                    <a href="${l.share_urls.telegram}" target="_blank" class="share-btn share-telegram" title="Telegram">‚úàÔ∏è</a>
                </div>
            </td>
        </tr>
    `).join('');
}

function resetFilters() {
    ['f-city','f-pmin','f-pmax','f-site','f-smin'].forEach(id => document.getElementById(id).value = '');
    applyFilters();
}

// Tri au clic - envelopp√© dans v√©rification de DOM
function setupTableListeners() {
    const tables = document.querySelectorAll('#main-table th[data-col]');
    if (tables.length === 0) {
        console.warn('[setupTableListeners] Table headers non trouv√©s');
        setTimeout(setupTableListeners, 100);
        return;
    }

    tables.forEach(th => {
        th.addEventListener('click', () => {
            const col = th.dataset.col;
            if (sortCol === col) { sortAsc = !sortAsc; } else { sortCol = col; sortAsc = true; }
            document.querySelectorAll('.sort-arrow').forEach(a => a.classList.remove('active'));
            th.querySelector('.sort-arrow').classList.add('active');
            th.querySelector('.sort-arrow').innerHTML = sortAsc ? '&#9650;' : '&#9660;';
            sortAndRender();
        });
    });
    console.log('[setupTableListeners] ‚úÖ Table listeners setup');
}

// Filtres en temps reel - envelopp√© dans v√©rification de DOM
function setupFilterListeners() {
    const cities = document.getElementById('f-city');
    if (!cities) {
        console.warn('[setupFilterListeners] Filter elements non trouv√©s');
        setTimeout(setupFilterListeners, 100);
        return;
    }

    ['f-city', 'f-site'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', applyFilters);
    });
    ['f-pmin', 'f-pmax', 'f-smin'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', applyFilters);
    });
    console.log('[setupFilterListeners] ‚úÖ Filter listeners setup');
}

setupTableListeners();
setupFilterListeners();

function initFilters() {
    const cities = [...new Set(LISTINGS.map(l => l.city).filter(c => c && c !== 'N/A'))].sort();
    const sites = [...new Set(LISTINGS.map(l => l.site).filter(Boolean))].sort();
    const citySelect = document.getElementById('f-city');
    cities.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; citySelect.appendChild(o); });
    const siteSelect = document.getElementById('f-site');
    sites.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; siteSelect.appendChild(o); });
}

// --- Vue par ville ---
function renderCityView() {
    const container = document.getElementById('city-container');
    const groups = {};
    LISTINGS.forEach(l => { const c = l.city || 'N/A'; if (!groups[c]) groups[c] = []; groups[c].push(l); });
    const sorted = Object.entries(groups).sort((a, b) => b[1].length - a[1].length);

    container.innerHTML = sorted.map(([city, items]) => {
        const prices = items.filter(l => l.price > 0).map(l => l.price);
        const avg = prices.length ? Math.round(prices.reduce((a,b) => a+b, 0) / prices.length) : 0;
        const mn = prices.length ? Math.min(...prices) : 0;
        const mx = prices.length ? Math.max(...prices) : 0;
        const rows = items.sort((a,b) => (a.price||0) - (b.price||0)).map(l => `
            <tr>
                <td>${badge(l.site)}</td>
                <td><strong>${fmt(l.price)}&euro;</strong></td>
                <td>${l.rooms || '‚Äî'} ch.</td>
                <td>${l.surface || '‚Äî'} m&sup2;</td>
                <td>${l.price_m2 ? l.price_m2 + ' &euro;/m&sup2;' : '‚Äî'}</td>
                <td><a href="${l.url}" target="_blank">${(l.title || 'Voir').substring(0, 45)}</a></td>
            </tr>
        `).join('');
        return `
            <div class="city-group">
                <h5>${city} <span class="listing-count">(${items.length} ann. | moy. ${fmt(avg)}&euro; | ${fmt(mn)}&euro; - ${fmt(mx)}&euro;)</span></h5>
                <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                    <thead><tr><th>Site</th><th>Prix</th><th>Ch.</th><th>m&sup2;</th><th>&euro;/m&sup2;</th><th>Titre</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
                </div>
            </div>
        `;
    }).join('');
}

// --- Vue par prix ---
function renderPriceView() {
    const container = document.getElementById('price-container');
    const ranges = [
        { label: 'Moins de 1 500 &euro;', min: 0, max: 1499, color: '#2ECC71' },
        { label: '1 500 - 2 000 &euro;', min: 1500, max: 1999, color: '#36A2EB' },
        { label: '2 000 - 2 500 &euro;', min: 2000, max: 2499, color: '#FFCE56' },
        { label: 'Plus de 2 500 &euro;', min: 2500, max: 999999, color: '#FF6384' }
    ];
    container.innerHTML = ranges.map(r => {
        const items = LISTINGS.filter(l => l.price >= r.min && l.price <= r.max).sort((a,b) => (a.price||0) - (b.price||0));
        if (!items.length) return '';
        const rows = items.map(l => `
            <tr>
                <td>${badge(l.site)}</td>
                <td>${l.city || '‚Äî'}</td>
                <td><strong>${fmt(l.price)}&euro;</strong></td>
                <td>${l.rooms || '‚Äî'} ch.</td>
                <td>${l.surface || '‚Äî'} m&sup2;</td>
                <td>${l.price_m2 ? l.price_m2 + ' &euro;/m&sup2;' : '‚Äî'}</td>
                <td><a href="${l.url}" target="_blank">${(l.title || 'Voir').substring(0, 45)}</a></td>
            </tr>
        `).join('');
        return `
            <div class="price-range-section">
                <h5><span class="price-badge" style="background:${r.color};color:white">${r.label}</span>
                    <span class="listing-count ms-2">${items.length} annonces</span></h5>
                <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                    <thead><tr><th>Site</th><th>Ville</th><th>Prix</th><th>Ch.</th><th>m&sup2;</th><th>&euro;/m&sup2;</th><th>Titre</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
                </div>
            </div>
        `;
    }).join('');
}

// --- Carte Leaflet (lazy load quand onglet actif) ---
let mapInit = false;
let mapInstance = null;
let markersLayer = L.layerGroup();
let heatmapLayer = null;
let currentMapMode = 'markers';

function initMap() {
    if (mapInit) return;
    mapInit = true;

    // Initialiser la carte une fois
    mapInstance = L.map('map').setView([49.6116, 6.1319], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(mapInstance);

    // üîò Boutons mode
    document.getElementById('map-mode-markers').addEventListener('click', () => {
        currentMapMode = 'markers';
        mapInstance.removeLayer(heatmapLayer);
        if (markersLayer.getLayers().length > 0) markersLayer.addTo(mapInstance);
        document.getElementById('map-mode-markers').classList.add('active');
        document.getElementById('map-mode-heatmap').classList.remove('active');
    });

    document.getElementById('map-mode-heatmap').addEventListener('click', () => {
        currentMapMode = 'heatmap';
        mapInstance.removeLayer(markersLayer);
        if (heatmapLayer) heatmapLayer.addTo(mapInstance);
        document.getElementById('map-mode-heatmap').classList.add('active');
        document.getElementById('map-mode-markers').classList.remove('active');
    });

    // Mettre √† jour avec les donn√©es filtr√©es
    updateMap();
}

function updateMap() {
    if (!mapInstance) return;

    // Utiliser 'filtered' (donn√©es filtr√©es) au lieu de 'LISTINGS'
    const withGPS = filtered.filter(l => l.latitude && l.longitude);

    if (!withGPS.length) {
        document.getElementById('map').innerHTML = '<p class="text-center text-muted py-5">Aucune annonce avec coordonnees GPS</p>';
        return;
    }

    // Vider les couches pr√©c√©dentes
    markersLayer.clearLayers();

    // üìç Cr√©er les markers avec donn√©es filtr√©es
    withGPS.forEach(l => {
        const color = SITE_COLORS[l.site] || '#888';
        L.circleMarker([l.latitude, l.longitude], {
            radius: 7, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.85
        }).addTo(markersLayer).bindPopup(`
            <strong>${l.city || '‚Äî'}</strong><br>
            ${fmt(l.price)}&euro; | ${l.rooms || '?'} ch. | ${l.surface || '?'} m&sup2;<br>
            <a href="${l.url}" target="_blank">Voir l'annonce</a>
        `);
    });

    // üî• Cr√©er la heatmap avec donn√©es filtr√©es
    const heatmapData = withGPS.map(l => [l.latitude, l.longitude, 0.7]);
    if (heatmapLayer) mapInstance.removeLayer(heatmapLayer);
    heatmapLayer = L.heatLayer(heatmapData, { max: 100, radius: 25, blur: 15, gradient: {0.4: 'blue', 0.65: 'lime', 0.8: 'yellow', 1.0: 'red'} });

    // Afficher selon le mode courant
    if (currentMapMode === 'markers') {
        if (heatmapLayer && mapInstance.hasLayer(heatmapLayer)) mapInstance.removeLayer(heatmapLayer);
        if (markersLayer.getLayers().length > 0) markersLayer.addTo(mapInstance);
    } else {
        if (markersLayer && mapInstance.hasLayer(markersLayer)) mapInstance.removeLayer(markersLayer);
        if (heatmapLayer) heatmapLayer.addTo(mapInstance);
    }

    // Ajuster la vue √† tous les markers visibles
    if (withGPS.length > 0) {
        const bounds = L.latLngBounds(withGPS.map(l => [l.latitude, l.longitude]));
        mapInstance.fitBounds(bounds, { padding: [30, 30] });
    }
}

// Setup map tab listener avec protection
function setupMapListener() {
    const mapBtn = document.querySelector('[data-bs-target="#tab-map"]');
    if (mapBtn) {
        mapBtn.addEventListener('shown.bs.tab', initMap);
        console.log('[setupMapListener] ‚úÖ Map listener setup');
    } else {
        console.warn('[setupMapListener] Map button not found');
    }
}
setupMapListener();

// --- Heatmap Tab ---
let heatmapTabInstance = null;
let heatmapTabInitialized = false;

function initHeatmapTab() {
    if (heatmapTabInitialized || !LISTINGS || LISTINGS.length === 0) return;

    const heatmapContainer = document.getElementById('heatmap');
    if (!heatmapContainer) {
        console.warn('[initHeatmapTab] Container not found');
        return;
    }

    console.log('[initHeatmapTab] Initializing heatmap...');

    // Cr√©er la carte
    heatmapTabInstance = L.map('heatmap').setView([49.6116, 6.1319], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
    }).addTo(heatmapTabInstance);

    // Cr√©er heatmap data
    const withGPS = LISTINGS.filter(l => l.latitude && l.longitude);
    if (withGPS.length === 0) {
        console.warn('[initHeatmapTab] Pas de donn√©es GPS');
        heatmapContainer.innerHTML = '<p class="text-center text-muted py-5">Aucune annonce avec coordonn√©es GPS</p>';
        return;
    }

    const heatmapData = withGPS.map(l => [l.latitude, l.longitude, 0.8]);
    const heatmapLayer = L.heatLayer(heatmapData, {
        max: 100,
        radius: 30,
        blur: 20,
        gradient: {0.2: 'blue', 0.4: 'lime', 0.6: 'yellow', 0.8: 'orange', 1.0: 'red'}
    });
    heatmapLayer.addTo(heatmapTabInstance);

    // Zoom sur enveloppe
    const bounds = L.latLngBounds(withGPS.map(l => [l.latitude, l.longitude]));
    heatmapTabInstance.fitBounds(bounds, {padding: [30, 30]});

    heatmapTabInitialized = true;
    console.log('[initHeatmapTab] ‚úÖ Heatmap initialized with', withGPS.length, 'points');
}

// Setup onglet heatmap
function setupHeatmapTab() {
    const heatmapBtn = document.querySelector('[data-bs-target="#tab-heatmap"]');
    if (heatmapBtn) {
        heatmapBtn.addEventListener('shown.bs.tab', initHeatmapTab);
        console.log('[setupHeatmapTab] ‚úÖ Setup done');
    } else {
        console.warn('[setupHeatmapTab] Button not found');
    }
}
setupHeatmapTab();

// --- Graphiques Chart.js ---
function initCharts() {
    // Graphique PAR SITE
    if (STATS && STATS.sites && Object.keys(STATS.sites).length > 0) {
        try {
            const sites = Object.entries(STATS.sites).map(([name, count]) => ({ site: name, count })).sort((a,b) => b.count - a.count);
            const siteChart = new Chart(document.getElementById('siteChart'), {
                type: 'doughnut',
                data: {
                    labels: sites.map(s => s.site),
                    datasets: [{
                        data: sites.map(s => s.count),
                        backgroundColor: sites.map(s => SITE_COLORS[s.site] || '#999')
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        } catch (e) { console.error('Erreur graphique sites:', e); }
    }

    // Graphique PAR VILLE
    if (STATS && STATS.by_city && STATS.by_city.length > 0) {
        try {
            const cityChart = new Chart(document.getElementById('cityChart'), {
                type: 'bar',
                data: {
                    labels: STATS.by_city.map(c => c.city),
                    datasets: [{
                        label: 'Annonces',
                        data: STATS.by_city.map(c => c.count),
                        backgroundColor: '#667eea'
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        } catch (e) { console.error('Erreur graphique villes:', e); }
    }
}

// --- Timeline ---
function initTimeline() {
    if (!LISTINGS || LISTINGS.length === 0) return;

    // Grouper par date
    const byDate = {};
    LISTINGS.forEach(l => {
        const date = l.created_at ? l.created_at.split(' ')[0] : 'N/A';
        if (!byDate[date]) byDate[date] = [];
        byDate[date].push(l);
    });

    const dates = Object.keys(byDate).sort();
    const counts = dates.map(d => byDate[d].length);

    // Graphique timeline
    const timelineCanvas = document.getElementById('timelineChart');
    if (timelineCanvas) {
        try {
            new Chart(timelineCanvas, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Annonces ajout√©es',
                        data: counts,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
            console.log('[initTimeline] ‚úÖ Timeline chart created');
        } catch (e) {
            console.error('[initTimeline] Error:', e);
        }
    }
}

// --- Anomalies ---
function initAnomalies() {
    if (!LISTINGS || LISTINGS.length === 0) return;

    const container = document.getElementById('anomalies-container');
    let html = '';

    // Annonces sans image
    const noImage = LISTINGS.filter(l => !l.image_url);
    html += `<div class="card mb-3"><div class="card-header">üì∏ Sans image (${noImage.length})</div><div class="card-body">`;
    if (noImage.length > 0) {
        html += '<ul style="font-size: 0.9rem; max-height: 200px; overflow-y: auto;">';
        noImage.slice(0, 10).forEach(l => {
            html += `<li>${l.site} - ${l.title.substring(0, 50)} (${l.city})</li>`;
        });
        if (noImage.length > 10) html += `<li><em>... et ${noImage.length - 10} autres</em></li>`;
        html += '</ul>';
    } else {
        html += '<p class="text-success">‚úÖ Toutes les annonces ont une image</p>';
    }
    html += '</div></div>';

    // Annonces sans GPS
    const noGPS = LISTINGS.filter(l => !l.latitude || !l.longitude);
    html += `<div class="card mb-3"><div class="card-header">üó∫Ô∏è Sans GPS (${noGPS.length})</div><div class="card-body">`;
    if (noGPS.length > 0) {
        html += '<ul style="font-size: 0.9rem; max-height: 200px; overflow-y: auto;">';
        noGPS.slice(0, 10).forEach(l => {
            html += `<li>${l.site} - ${l.title.substring(0, 50)} (${l.city})</li>`;
        });
        if (noGPS.length > 10) html += `<li><em>... et ${noGPS.length - 10} autres</em></li>`;
        html += '</ul>';
    } else {
        html += '<p class="text-success">‚úÖ Toutes les annonces ont des coordonn√©es GPS</p>';
    }
    html += '</div></div>';

    // Donn√©es incompl√®tes
    const incomplete = LISTINGS.filter(l => !l.price || !l.rooms || !l.surface);
    html += `<div class="card mb-3"><div class="card-header">‚ö†Ô∏è Donn√©es incompl√®tes (${incomplete.length})</div><div class="card-body">`;
    if (incomplete.length > 0) {
        html += '<ul style="font-size: 0.9rem; max-height: 200px; overflow-y: auto;">';
        incomplete.slice(0, 10).forEach(l => {
            const missing = [];
            if (!l.price) missing.push('prix');
            if (!l.rooms) missing.push('chambres');
            if (!l.surface) missing.push('surface');
            html += `<li>${l.site} - manque: ${missing.join(', ')}</li>`;
        });
        if (incomplete.length > 10) html += `<li><em>... et ${incomplete.length - 10} autres</em></li>`;
        html += '</ul>';
    } else {
        html += '<p class="text-success">‚úÖ Toutes les annonces sont compl√®tes</p>';
    }
    html += '</div></div>';

    container.innerHTML = html;
    console.log('[initAnomalies] ‚úÖ Anomalies initialized');
}

// --- Fonction attendre LISTINGS et initialiser ---
function waitForDataAndInit() {
    console.log('[waitForDataAndInit] V√©rification LISTINGS...');

    // Attendre que LISTINGS soit charg√©
    if (typeof LISTINGS === 'undefined') {
        console.warn('[waitForDataAndInit] LISTINGS undefined, retry...');
        setTimeout(waitForDataAndInit, 100);
        return;
    }

    if (!LISTINGS) {
        console.warn('[waitForDataAndInit] LISTINGS is null/falsy, retry...');
        setTimeout(waitForDataAndInit, 100);
        return;
    }

    if (LISTINGS.length === 0) {
        console.warn('[waitForDataAndInit] LISTINGS is empty, retry...');
        setTimeout(waitForDataAndInit, 100);
        return;
    }

    console.log('‚úÖ LISTINGS charg√©:', LISTINGS.length, 'annonces');
    console.log('[waitForDataAndInit] Premier listing:', LISTINGS[0]);

    try {
        // Initialiser les donn√©es de base
        console.log('[waitForDataAndInit] Copie LISTINGS -> filtered');
        filtered = [...LISTINGS];
        console.log('[waitForDataAndInit] filtered maintenant a', filtered.length, 'annonces');

        // Remplir le tableau
        const tbody = document.getElementById('table-body');
        console.log('[waitForDataAndInit] tbody element:', tbody);

        if (!tbody) {
            console.error('‚ùå tbody element non trouv√©!');
            return;
        }

        if (LISTINGS.length > 0) {
            console.log('[waitForDataAndInit] Appel initFilters()...');
            initFilters();
            console.log('[waitForDataAndInit] ‚úÖ initFilters() OK');

            console.log('[waitForDataAndInit] Appel applyFilters()...');
            applyFilters();
            console.log('[waitForDataAndInit] ‚úÖ applyFilters() OK, filtered a', filtered.length, 'annonces');
        }

        // Rendre les vues
        console.log('[waitForDataAndInit] Appel renderCityView()...');
        renderCityView();
        console.log('[waitForDataAndInit] ‚úÖ renderCityView() OK');

        console.log('[waitForDataAndInit] Appel renderPriceView()...');
        renderPriceView();
        console.log('[waitForDataAndInit] ‚úÖ renderPriceView() OK');

        console.log('[waitForDataAndInit] Appel initTimeline()...');
        initTimeline();
        console.log('[waitForDataAndInit] ‚úÖ initTimeline() OK');

        console.log('[waitForDataAndInit] Appel initAnomalies()...');
        initAnomalies();
        console.log('[waitForDataAndInit] ‚úÖ initAnomalies() OK');

        console.log('[waitForDataAndInit] Appel initCharts()...');
        initCharts();
        console.log('[waitForDataAndInit] ‚úÖ initCharts() OK');

        console.log('üéâ Dashboard initialis√© compl√®tement avec', LISTINGS.length, 'annonces');
    } catch (e) {
        console.error('‚ùå Erreur initialisation:', e.message);
        console.error('Stack:', e.stack);
        const tb = document.getElementById('table-body');
        if (tb) tb.innerHTML = '<tr><td colspan="9" class="alert alert-danger m-3">Erreur: ' + e.message + '<br/>' + e.stack + '</td></tr>';
    }
}

// Lancer l'initialisation quand le document est pr√™t
console.log('[Init] document.readyState:', document.readyState);
if (document.readyState === 'loading') {
    console.log('[Init] En attente de DOMContentLoaded...');
    document.addEventListener('DOMContentLoaded', function() {
        console.log('[DOMContentLoaded] Appel waitForDataAndInit()');
        waitForDataAndInit();
    });
} else {
    console.log('[Init] Document d√©j√† charg√©, appel waitForDataAndInit() imm√©diatement');
    waitForDataAndInit();
}
</script>
</body>
</html>