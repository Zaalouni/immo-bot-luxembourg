<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="ImmoLux Dashboard - Annonces immobili√®res au Luxembourg">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ImmoLux">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23667eea' width='180' height='180'/><text x='90' y='100' font-size='100' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle'>üè†</text></svg>">
    <title>ImmoLux Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5a6fd6;
            --primary-light: #8b9cff;
            --secondary: #764ba2;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --text-dark: #2c3e50;
            --text-light: #95a5a6;
            --border-light: #ecf0f1;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            color: var(--text-dark);
            min-height: 100vh;
            padding-bottom: 2rem;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ecf0f1;
        }

        body.dark-mode .header,
        body.dark-mode .stat-card,
        body.dark-mode .filter-section,
        body.dark-mode .card,
        body.dark-mode .city-group,
        body.dark-mode .price-range-section,
        body.dark-mode .nav-tabs {
            background: rgba(255, 255, 255, 0.05);
            color: #ecf0f1;
            border-color: rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .table {
            color: #ecf0f1;
        }

        body.dark-mode .table th,
        body.dark-mode .table td {
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header small {
            opacity: 0.85;
            font-size: 0.9rem;
            margin-top: 0.3rem;
            display: block;
        }

        .header-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }

        /* DARK MODE TOGGLE */
        .dark-mode-toggle {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dark-mode-toggle:hover {
            transform: scale(1.1);
            background: var(--primary-dark);
        }

        /* STATS CARDS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 1.2rem;
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            background: rgba(255, 255, 255, 0.9);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.3rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        /* CONTAINER */
        .container-main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* FILTER SECTION */
        .filter-section {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .filter-section strong {
            color: var(--primary);
            font-weight: 600;
        }

        /* SITE BADGES */
        .site-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.5rem;
            margin-bottom: 0.3rem;
        }

        /* NAV TABS */
        .nav-tabs {
            position: sticky;
            top: 80px;
            z-index: 999;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 0.5rem;
            margin-bottom: 1rem;
        }

        .nav-link {
            color: #666;
            font-weight: 500;
            font-size: 0.9rem;
            border: none;
            border-radius: 10px;
            transition: var(--transition);
            padding: 0.5rem 1rem;
        }

        .nav-link:hover {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary);
        }

        .nav-link.active {
            color: white;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }

        /* CARDS */
        .card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 1rem;
        }

        .card-header {
            background: rgba(255, 255, 255, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 600;
            border-radius: 16px 16px 0 0;
        }

        /* CITY GROUP */
        .city-group {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .city-group h5 {
            color: var(--primary);
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* PRICE RANGE SECTION */
        .price-range-section {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .price-range-section h5 {
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .price-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* TABLE */
        .table {
            font-size: 0.85rem;
            margin-bottom: 0;
        }

        .table th {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary);
            transition: var(--transition);
        }

        .table th:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .table td {
            vertical-align: middle;
            padding: 0.8rem;
        }

        .table tbody tr {
            transition: var(--transition);
        }

        .table tbody tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .sort-arrow {
            opacity: 0.3;
            margin-left: 2px;
            transition: var(--transition);
        }

        .sort-arrow.active {
            opacity: 1;
            color: var(--primary);
        }

        /* MAP */
        #map {
            height: 350px;
            border-radius: 12px;
        }

        /* LINKS */
        a {
            color: var(--primary);
            text-decoration: none;
            transition: var(--transition);
        }

        a:hover {
            text-decoration: underline;
            opacity: 0.8;
        }

        .listing-count {
            font-size: 0.8rem;
            color: #888;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.4rem;
            }

            .header-stats {
                gap: 1rem;
                font-size: 0.8rem;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 0.8rem;
            }

            .stat-value {
                font-size: 1.3rem;
            }

            .stat-label {
                font-size: 0.65rem;
            }

            .table {
                font-size: 0.7rem;
            }

            .table th, .table td {
                padding: 0.5rem;
            }

            #map {
                height: 280px;
            }

            .container-main {
                padding: 0 0.5rem;
            }

            .nav-tabs {
                position: relative;
                top: auto;
            }
        }
    </style>
</head>
<body>

<!-- Header -->
<div class="header">
    <div class="header-content">
        <div>
            <h1>üè† ImmoLux Dashboard</h1>
            <small id="lastUpdate">Mis √† jour: 27/02/2026</small>
        </div>
        <div class="header-stats">
            <div>üìä <strong id="totalCount">114</strong> annonces</div>
            <div>üèôÔ∏è <strong id="cityCount">63</strong> villes</div>
            <div>üåê <strong id="siteCount">7</strong> sites</div>
        </div>
    </div>
</div>

<div class="container-main">

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="statTotal">114</div>
            <div class="stat-label">Annonces</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statAvgPrice">2187‚Ç¨</div>
            <div class="stat-label">Prix Moyen</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statMinPrice">1400‚Ç¨</div>
            <div class="stat-label">Prix Min</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statMaxPrice">2500‚Ç¨</div>
            <div class="stat-label">Prix Max</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statAvgSurface">97m¬≤</div>
            <div class="stat-label">Surface Avg</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statCities">63</div>
            <div class="stat-label">Villes</div>
        </div>
    </div>

    <!-- Sites Badges -->
    <div class="filter-section">
        <strong>üìç Sites :</strong>
        <div id="siteBadges" style="margin-top: 0.8rem;"></div>
    </div>

    <!-- Navigation -->
    <div class="filter-section">
        <strong>üîó Plus de vues :</strong>
        <div style="margin-top: 0.8rem;">
            <!-- Pages Principales -->
            <a href="dashboard-summary.html" class="btn btn-sm btn-outline-primary ms-1">üìä R√©sum√©</a>
            <a href="map.html" class="btn btn-sm btn-outline-primary ms-1">üó∫Ô∏è Carte</a>
            <a href="map-advanced.html" class="btn btn-sm btn-outline-primary ms-1">üó∫Ô∏è Carte+</a>
            <a href="stats-by-city.html" class="btn btn-sm btn-outline-primary ms-1">üìã Stats Ville</a>
            <a href="nearby.html" class="btn btn-sm btn-outline-primary ms-1">üìç Proche</a>
            <a href="photos.html" class="btn btn-sm btn-outline-primary ms-1">üì∏ Photos</a>
            <a href="anomalies.html" class="btn btn-sm btn-outline-primary ms-1">‚ö†Ô∏è Anomalies</a>
            <a href="new-listings.html" class="btn btn-sm btn-outline-primary ms-1">‚ú® Nouvelles</a>
            <!-- Pages Avanc√©es -->
            <a href="comparison.html" class="btn btn-sm btn-outline-success ms-1">üîÑ Comparateur</a>
            <a href="trends.html" class="btn btn-sm btn-outline-success ms-1">üìà Tendances</a>
            <a href="reports.html" class="btn btn-sm btn-outline-success ms-1">üìÑ Reports</a>
            <a href="alerts.html" class="btn btn-sm btn-outline-success ms-1">‚≠ê Favoris</a>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-2" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-table">üìã Tableau</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-city">üèôÔ∏è Par Ville</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-price">üí∞ Par Prix</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-map">üó∫Ô∏è Carte</button>
        </li>
    </ul>

    <div class="tab-content">

        <!-- TAB: Tableau -->
        <div class="tab-pane fade show active" id="tab-table">
            <div class="filter-section">
                <div class="row g-2 align-items-end">
                    <div class="col-6 col-md-3">
                        <label class="form-label form-label-sm mb-0">Ville</label>
                        <select id="f-city" class="form-select form-select-sm"><option value="">Toutes</option></select>
                    </div>
                    <div class="col-3 col-md-2">
                        <label class="form-label form-label-sm mb-0">Prix min</label>
                        <input type="number" id="f-pmin" class="form-control form-control-sm" placeholder="0">
                    </div>
                    <div class="col-3 col-md-2">
                        <label class="form-label form-label-sm mb-0">Prix max</label>
                        <input type="number" id="f-pmax" class="form-control form-control-sm" placeholder="9999">
                    </div>
                    <div class="col-6 col-md-2">
                        <label class="form-label form-label-sm mb-0">Site</label>
                        <select id="f-site" class="form-select form-select-sm"><option value="">Tous</option></select>
                    </div>
                    <div class="col-3 col-md-2">
                        <label class="form-label form-label-sm mb-0">m¬≤ min</label>
                        <input type="number" id="f-smin" class="form-control form-control-sm" placeholder="0">
                    </div>
                    <div class="col-3 col-md-1">
                        <button class="btn btn-sm btn-outline-secondary w-100" onclick="resetFilters()">Reset</button>
                    </div>
                </div>
            </div>
            <div class="card mt-2">
                <div class="card-header d-flex justify-content-between py-2">
                    <span>Annonces</span>
                    <span id="table-count" class="listing-count"></span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="main-table">
                        <thead>
                            <tr>
                                <th data-col="site">Site <span class="sort-arrow">‚ñ≤</span></th>
                                <th data-col="city">Ville <span class="sort-arrow">‚ñ≤</span></th>
                                <th data-col="price">Prix <span class="sort-arrow">‚ñ≤</span></th>
                                <th data-col="rooms">Ch. <span class="sort-arrow">‚ñ≤</span></th>
                                <th data-col="surface">m¬≤ <span class="sort-arrow">‚ñ≤</span></th>
                                <th data-col="price_m2">‚Ç¨/m¬≤ <span class="sort-arrow">‚ñ≤</span></th>
                                <th data-col="distance_km">Dist. <span class="sort-arrow">‚ñ≤</span></th>
                                <th>Titre</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: Par Ville -->
        <div class="tab-pane fade" id="tab-city">
            <div id="city-container"></div>
        </div>

        <!-- TAB: Par Prix -->
        <div class="tab-pane fade" id="tab-price">
            <div id="price-container"></div>
        </div>

        <!-- TAB: Carte -->
        <div class="tab-pane fade" id="tab-map">
            <div class="card">
                <div class="card-body p-0">
                    <div id="map"></div>
                </div>
            </div>
        </div>

    </div>

</div>

<!-- Dark Mode Toggle -->
<button class="dark-mode-toggle" id="darkModeToggle" title="Mode sombre">üåô</button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="data/listings.js"></script>
<script src="data/stats.js"></script>
<script>
    // ==================== DARK MODE ====================
    const darkModeToggle = document.getElementById('darkModeToggle');
    darkModeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    });

    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
    }

    // ==================== UTILITAIRES ====================
    function fmt(n) { return n ? n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ') : '‚Äî'; }
    function badge(site) {
        const bg = SITE_COLORS[site] || '#888';
        return `<span class="site-badge" style="background:${bg}">${site}</span>`;
    }

    // ==================== TABLEAU TRIABLE ====================
    let sortCol = 'price';
    let sortAsc = true;
    let filtered = [...LISTINGS];

    function applyFilters() {
        const city = document.getElementById('f-city').value;
        const pmin = parseInt(document.getElementById('f-pmin').value) || 0;
        const pmax = parseInt(document.getElementById('f-pmax').value) || 999999;
        const site = document.getElementById('f-site').value;
        const smin = parseInt(document.getElementById('f-smin').value) || 0;

        filtered = LISTINGS.filter(l => {
            if (city && l.city !== city) return false;
            if (l.price < pmin || l.price > pmax) return false;
            if (site && l.site !== site) return false;
            if (smin && (!l.surface || l.surface < smin)) return false;
            return true;
        });
        sortAndRender();
    }

    function sortAndRender() {
        filtered.sort((a, b) => {
            let va = a[sortCol], vb = b[sortCol];
            if (va == null) va = sortAsc ? Infinity : -Infinity;
            if (vb == null) vb = sortAsc ? Infinity : -Infinity;
            if (typeof va === 'string') return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
            return sortAsc ? va - vb : vb - va;
        });
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('table-body');
        document.getElementById('table-count').textContent = filtered.length + ' / ' + LISTINGS.length;
        if (!filtered.length) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-3">Aucune annonce</td></tr>';
            return;
        }
        tbody.innerHTML = filtered.map(l => `
            <tr>
                <td>${badge(l.site)}</td>
                <td>${l.city || '‚Äî'}</td>
                <td><strong>${fmt(l.price)}‚Ç¨</strong></td>
                <td>${l.rooms || '‚Äî'}</td>
                <td>${l.surface || '‚Äî'}</td>
                <td>${l.price_m2 ? l.price_m2 + '‚Ç¨' : '‚Äî'}</td>
                <td>${l.distance_km != null ? l.distance_km + ' km' : '‚Äî'}</td>
                <td><a href="${l.url}" target="_blank">${(l.title || 'Voir').substring(0, 50)}</a></td>
            </tr>
        `).join('');
    }

    function resetFilters() {
        ['f-city','f-pmin','f-pmax','f-site','f-smin'].forEach(id => document.getElementById(id).value = '');
        applyFilters();
    }

    // Tri au clic
    document.querySelectorAll('#main-table th[data-col]').forEach(th => {
        th.addEventListener('click', () => {
            const col = th.dataset.col;
            if (sortCol === col) { sortAsc = !sortAsc; } else { sortCol = col; sortAsc = true; }
            document.querySelectorAll('.sort-arrow').forEach(a => a.classList.remove('active'));
            th.querySelector('.sort-arrow').classList.add('active');
            th.querySelector('.sort-arrow').innerHTML = sortAsc ? '‚ñ≤' : '‚ñº';
            sortAndRender();
        });
    });

    // Filtres en temps reel
    ['f-city', 'f-site'].forEach(id => document.getElementById(id).addEventListener('change', applyFilters));
    ['f-pmin', 'f-pmax', 'f-smin'].forEach(id => document.getElementById(id).addEventListener('input', applyFilters));

    function initFilters() {
        const cities = [...new Set(LISTINGS.map(l => l.city).filter(c => c && c !== 'N/A'))].sort();
        const sites = [...new Set(LISTINGS.map(l => l.site).filter(Boolean))].sort();
        const citySelect = document.getElementById('f-city');
        cities.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; citySelect.appendChild(o); });
        const siteSelect = document.getElementById('f-site');
        sites.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; siteSelect.appendChild(o); });

        // Remplir les badges de sites
        const badgesDiv = document.getElementById('siteBadges');
        const siteCounts = {};
        LISTINGS.forEach(l => siteCounts[l.site] = (siteCounts[l.site] || 0) + 1);
        badgesDiv.innerHTML = Object.entries(siteCounts).sort((a, b) => b[1] - a[1]).map(([site, count]) => {
            const bg = SITE_COLORS[site] || '#888';
            return `<span class="site-badge" style="background:${bg}">${site} (${count})</span>`;
        }).join(' ');
    }

    // ==================== VUE PAR VILLE ====================
    function renderCityView() {
        const container = document.getElementById('city-container');
        const groups = {};
        LISTINGS.forEach(l => { const c = l.city || 'N/A'; if (!groups[c]) groups[c] = []; groups[c].push(l); });
        const sorted = Object.entries(groups).sort((a, b) => b[1].length - a[1].length);

        container.innerHTML = sorted.map(([city, items]) => {
            const prices = items.filter(l => l.price > 0).map(l => l.price);
            const avg = prices.length ? Math.round(prices.reduce((a,b) => a+b, 0) / prices.length) : 0;
            const mn = prices.length ? Math.min(...prices) : 0;
            const mx = prices.length ? Math.max(...prices) : 0;
            const rows = items.sort((a,b) => (a.price||0) - (b.price||0)).map(l => `
                <tr>
                    <td>${badge(l.site)}</td>
                    <td><strong>${fmt(l.price)}‚Ç¨</strong></td>
                    <td>${l.rooms || '‚Äî'} ch.</td>
                    <td>${l.surface || '‚Äî'} m¬≤</td>
                    <td>${l.price_m2 ? l.price_m2 + ' ‚Ç¨/m¬≤' : '‚Äî'}</td>
                    <td><a href="${l.url}" target="_blank">${(l.title || 'Voir').substring(0, 45)}</a></td>
                </tr>
            `).join('');
            return `
                <div class="city-group">
                    <h5>üìç ${city} <span class="listing-count">(${items.length} ann. | moy. ${fmt(avg)}‚Ç¨ | ${fmt(mn)}‚Ç¨ - ${fmt(mx)}‚Ç¨)</span></h5>
                    <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead><tr><th>Site</th><th>Prix</th><th>Ch.</th><th>m¬≤</th><th>‚Ç¨/m¬≤</th><th>Titre</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ==================== VUE PAR PRIX ====================
    function renderPriceView() {
        const container = document.getElementById('price-container');
        const ranges = [
            { label: 'Moins de 1 500 ‚Ç¨', min: 0, max: 1499, color: '#2ECC71' },
            { label: '1 500 - 2 000 ‚Ç¨', min: 1500, max: 1999, color: '#36A2EB' },
            { label: '2 000 - 2 500 ‚Ç¨', min: 2000, max: 2499, color: '#FFCE56' },
            { label: 'Plus de 2 500 ‚Ç¨', min: 2500, max: 999999, color: '#FF6384' }
        ];
        container.innerHTML = ranges.map(r => {
            const items = LISTINGS.filter(l => l.price >= r.min && l.price <= r.max).sort((a,b) => (a.price||0) - (b.price||0));
            if (!items.length) return '';
            const rows = items.map(l => `
                <tr>
                    <td>${badge(l.site)}</td>
                    <td>${l.city || '‚Äî'}</td>
                    <td><strong>${fmt(l.price)}‚Ç¨</strong></td>
                    <td>${l.rooms || '‚Äî'} ch.</td>
                    <td>${l.surface || '‚Äî'} m¬≤</td>
                    <td>${l.price_m2 ? l.price_m2 + ' ‚Ç¨/m¬≤' : '‚Äî'}</td>
                    <td><a href="${l.url}" target="_blank">${(l.title || 'Voir').substring(0, 45)}</a></td>
                </tr>
            `).join('');
            return `
                <div class="price-range-section">
                    <h5><span class="price-badge" style="background:${r.color};color:white">${r.label}</span>
                        <span class="listing-count ms-2">${items.length} annonces</span></h5>
                    <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead><tr><th>Site</th><th>Ville</th><th>Prix</th><th>Ch.</th><th>m¬≤</th><th>‚Ç¨/m¬≤</th><th>Titre</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ==================== CARTE LEAFLET ====================
    let mapInit = false;
    document.querySelector('[data-bs-target="#tab-map"]').addEventListener('shown.bs.tab', () => {
        if (mapInit) return;
        mapInit = true;
        const withGPS = LISTINGS.filter(l => l.latitude && l.longitude);
        if (!withGPS.length) {
            document.getElementById('map').innerHTML = '<p class="text-center text-muted py-5">Aucune annonce avec coordonn√©es GPS</p>';
            return;
        }
        const map = L.map('map').setView([49.6116, 6.1319], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
        withGPS.forEach(l => {
            const color = SITE_COLORS[l.site] || '#888';
            L.circleMarker([l.latitude, l.longitude], {
                radius: 7, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.85
            }).addTo(map).bindPopup(`
                <strong>${l.city || '‚Äî'}</strong><br>
                ${fmt(l.price)}‚Ç¨ | ${l.rooms || '?'} ch. | ${l.surface || '?'} m¬≤<br>
                <a href="${l.url}" target="_blank">Voir l'annonce</a>
            `);
        });
        map.fitBounds(withGPS.map(l => [l.latitude, l.longitude]), { padding: [30, 30] });
    });

    // ==================== SERVICE WORKER ====================
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed'));
    }

    // ==================== INIT ====================
    document.getElementById('lastUpdate').textContent = `Mis √† jour: ${new Date().toLocaleString('fr-FR')}`;
    initFilters();
    applyFilters();
    renderCityView();
    renderPriceView();
</script>
</body>
</html>
