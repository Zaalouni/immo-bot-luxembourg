<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Immo Bot Luxembourg ‚Äî Dashboard</title>
<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#212529">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Immo Bot LU">
<link rel="apple-touch-icon" href="icon.svg">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" rel="stylesheet">
<style>
  body { background:#f8f9fa; font-size:.9rem; }
  .stat-card { border-radius:12px; border:none; box-shadow:0 2px 8px rgba(0,0,0,.08); }
  .stat-val  { font-size:1.8rem; font-weight:700; line-height:1; }
  .stat-label { font-size:.75rem; color:#6c757d; text-transform:uppercase; letter-spacing:.05em; }
  #map { height:520px; border-radius:0 0 12px 12px; }
  .map-card { border-radius:12px; border:none; box-shadow:0 2px 12px rgba(0,0,0,.12); overflow:hidden; }
  .filter-card, .table-container { border-radius:12px; border:none; box-shadow:0 2px 8px rgba(0,0,0,.08); background:white; }
  .badge-site { font-size:.7rem; padding:.25em .5em; }
  #compare-btn { display:none; }
  a.al { text-decoration:none; color:#0d6efd; }
  a.al:hover { text-decoration:underline; }
  .pm2 { font-size:.75rem; color:#6c757d; }
  th { white-space:nowrap; }
  .map-header { background:#212529; color:#fff; padding:.55rem 1rem; font-weight:600; font-size:.95rem;
    display:flex; align-items:center; justify-content:space-between; border-radius:12px 12px 0 0; }
  .map-legend { display:flex; gap:10px; font-size:.75rem; color:#ccc; align-items:center; }
  .dot { width:10px; height:10px; border-radius:50%; display:inline-block; border:1px solid #fff5; }
  .map-info { position:absolute; bottom:10px; left:10px; z-index:1000;
    background:rgba(255,255,255,.92); border-radius:8px; padding:4px 10px;
    font-size:.78rem; box-shadow:0 1px 5px rgba(0,0,0,.2); }
  .price-pill { display:inline-block; background:#0d6efd; color:#fff; border-radius:10px;
    padding:1px 7px; font-size:.7rem; font-weight:600; white-space:nowrap; }
</style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-3">
  <div class="container-fluid">
    <span class="navbar-brand fw-bold">üè† Immo Bot Luxembourg</span>
    <span class="text-secondary small">Mis √† jour : 20/02/2026 20:53</span>
  </div>
</nav>

<div class="container-fluid px-4">

<!-- STATS -->
<div class="row g-3 mb-3">
  <div class="col-6 col-md-2"><div class="card stat-card h-100"><div class="card-body text-center">
    <div class="stat-val text-primary">0</div><div class="stat-label">Annonces</div>
  </div></div></div>
  <div class="col-6 col-md-2"><div class="card stat-card h-100"><div class="card-body text-center">
    <div class="stat-val text-success">0‚Ç¨</div><div class="stat-label">Prix moyen</div>
  </div></div></div>
  <div class="col-6 col-md-2"><div class="card stat-card h-100"><div class="card-body text-center">
    <div class="stat-val text-info">0 m¬≤</div><div class="stat-label">Surface moy.</div>
  </div></div></div>
  <div class="col-6 col-md-2"><div class="card stat-card h-100"><div class="card-body text-center">
    <div class="stat-val text-warning">0‚Ç¨</div><div class="stat-label">‚Ç¨/m¬≤ moyen</div>
  </div></div></div>
  <div class="col-6 col-md-2"><div class="card stat-card h-100"><div class="card-body text-center">
    <div class="stat-val text-danger">0‚Ç¨</div><div class="stat-label">Prix min</div>
  </div></div></div>
  <div class="col-6 col-md-2"><div class="card stat-card h-100"><div class="card-body text-center">
    <div class="stat-val">0‚Ç¨</div><div class="stat-label">Prix max</div>
  </div></div></div>
</div>

<div class="card filter-card mb-3 p-2">
  <span class="text-muted small me-2">Sites :</span>
  <span class="ms-3 text-muted small">Notifi√©es : <strong>0</strong></span>
  <span class="ms-3 text-muted small">Distance moy. : <strong>N/A</strong></span>
  <span class="ms-3 text-muted small">G√©olocalis√©es : <strong>0</strong></span>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CARTE ‚Äî affich√©e EN PREMIER, grande, avec clusters
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="map-card mb-4" style="position:relative">
  <div class="map-header">
    <span>üó∫Ô∏è Carte des annonces g√©olocalis√©es &nbsp;<span id="map-count" class="badge bg-primary">0</span></span>
    <div class="map-legend">
      <span><span class="dot" style="background:#198754"></span> &lt; 2 km</span>
      <span><span class="dot" style="background:#0d6efd"></span> &lt; 5 km</span>
      <span><span class="dot" style="background:#ffc107"></span> &lt; 10 km</span>
      <span><span class="dot" style="background:#dc3545"></span> 10+ km</span>
      <span><span class="dot" style="background:#6c757d"></span> N/A</span>
    </div>
  </div>
  <div id="map"></div>
</div>

<!-- FILTRES -->
<div class="card filter-card mb-3">
  <div class="card-header fw-semibold py-2">üîç Filtres ‚Äî liste &amp; carte</div>
  <div class="card-body py-2">
    <div class="row g-2 align-items-end">
      <div class="col-12 col-md-2">
        <label class="form-label mb-1 small">Ville</label>
        <select id="f-city" class="form-select form-select-sm" multiple size="3">
          
        </select>
      </div>
      <div class="col-12 col-md-2">
        <label class="form-label mb-1 small">Site</label>
        <select id="f-site" class="form-select form-select-sm" multiple size="3">
          
        </select>
      </div>
      <div class="col-6 col-md-1">
        <label class="form-label mb-1 small">Prix min ‚Ç¨</label>
        <input id="f-pmin" type="number" class="form-control form-control-sm" placeholder="1000" step="100">
      </div>
      <div class="col-6 col-md-1">
        <label class="form-label mb-1 small">Prix max ‚Ç¨</label>
        <input id="f-pmax" type="number" class="form-control form-control-sm" placeholder="3000" step="100">
      </div>
      <div class="col-6 col-md-1">
        <label class="form-label mb-1 small">Surface min m¬≤</label>
        <input id="f-smin" type="number" class="form-control form-control-sm" placeholder="0">
      </div>
      <div class="col-6 col-md-1">
        <label class="form-label mb-1 small">Pi√®ces</label>
        <select id="f-rooms" class="form-select form-select-sm">
          <option value="">Toutes</option>
          <option value="1">1</option><option value="2">2</option>
          <option value="3">3</option><option value="4">4+</option>
        </select>
      </div>
      <div class="col-6 col-md-1">
        <label class="form-label mb-1 small">Dist. max km</label>
        <input id="f-dmax" type="number" class="form-control form-control-sm" placeholder="15">
      </div>
      <div class="col-6 col-md-1">
        <label class="form-label mb-1 small">Notifi√©</label>
        <select id="f-notif" class="form-select form-select-sm">
          <option value="">Tous</option>
          <option value="1">Oui</option><option value="0">Non</option>
        </select>
      </div>
      <div class="col-12 col-md-2 d-flex gap-2">
        <button class="btn btn-primary btn-sm w-100" onclick="applyFilters()">Appliquer</button>
        <button class="btn btn-outline-secondary btn-sm w-100" onclick="resetFilters()">Reset</button>
      </div>
    </div>
  </div>
</div>

<div class="mb-3 d-flex align-items-center gap-3">
  <span class="text-muted small" id="result-count"></span>
  <button id="compare-btn" class="btn btn-warning btn-sm" onclick="openCompare()">
    ‚öñÔ∏è Comparer (<span id="cmp-cnt">0</span> s√©lectionn√©es)
  </button>
</div>

<!-- TABLEAU -->
<div class="table-container mb-5" style="overflow-x:auto">
  <table id="tbl" class="table table-hover table-sm table-bordered mb-0" style="width:100%">
    <thead class="table-dark">
      <tr>
        <th><input type="checkbox" id="chk-all" onchange="toggleAll(this)"></th>
        <th>Site</th><th>Ville</th><th>Prix ‚Ç¨</th><th>m¬≤</th><th>‚Ç¨/m¬≤</th>
        <th>Pi√®ces</th><th>Distance</th><th>Titre</th><th>Date</th><th>‚úâÔ∏è</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

</div>

<!-- MODAL COMPARATEUR -->
<div class="modal fade" id="cmp-modal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">‚öñÔ∏è Comparateur</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="cmp-body"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
const ALL = [];
let filtered = [...ALL];
let cmpSet = new Set();
let dt, mapObj, clusterGroup = null;

const SITE_COLORS = {
  'Athome.lu':'bg-primary','Immotop.lu':'bg-success','Luxhome.lu':'bg-info text-dark',
  'VIVI.lu':'bg-warning text-dark','Nextimmo.lu':'bg-secondary','Newimmo.lu':'bg-danger',
  'Unicorn.lu':'bg-dark','Remax.lu':'bg-success'
};

window.addEventListener('DOMContentLoaded', () => { initMap(); render(ALL); });

function fmt(n) { return n != null ? Number(n).toLocaleString('fr-FR') : '‚Äî'; }
function trunc(s,n) { return s && s.length>n ? s.slice(0,n)+'‚Ä¶' : (s||'‚Äî'); }
function dBadge(d) {
  if(d==null) return 'bg-secondary';
  return d<2?'bg-success':d<5?'bg-primary':d<10?'bg-warning text-dark':'bg-danger';
}
function dColor(d) {
  if(d==null) return '#6c757d';
  return d<2?'#198754':d<5?'#0d6efd':d<10?'#ffc107':'#dc3545';
}

function render(data) {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  data.forEach(l => {
    const pm2 = (l.price>0&&l.surface>0) ? Math.round(l.price/l.surface*10)/10 : '';
    const dist = l.distance_km!=null
      ? `<span class="badge ${dBadge(l.distance_km)}">${l.distance_km.toFixed(1)} km</span>`
      : '<span class="text-muted small">‚Äî</span>';
    const site = l.site||'‚Äî';
    const sc = SITE_COLORS[site]||'bg-secondary';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="cchk" value="${l.id}" onchange="togCmp(${l.id},this)"></td>
      <td><span class="badge ${sc} badge-site">${site}</span></td>
      <td>${l.city||'‚Äî'}</td>
      <td class="fw-bold">${l.price?fmt(l.price)+' ‚Ç¨':'‚Äî'}</td>
      <td>${l.surface||'‚Äî'}</td>
      <td class="pm2">${pm2?pm2+' ‚Ç¨':'‚Äî'}</td>
      <td>${l.rooms||'‚Äî'}</td>
      <td>${dist}</td>
      <td><a class="al" href="${l.url}" target="_blank" title="${l.title}">${trunc(l.title,55)}</a></td>
      <td class="text-muted small">${l.created_at?l.created_at.slice(0,10):'‚Äî'}</td>
      <td class="text-center">${l.notified?'‚úÖ':''}</td>`;
    tbody.appendChild(tr);
  });
  if(dt) { dt.destroy(); }
  dt = $('#tbl').DataTable({
    paging:true, pageLength:25, ordering:true, order:[[3,'asc']], searching:true,
    language:{ url:'https://cdn.datatables.net/plug-ins/1.13.8/i18n/fr-FR.json' },
    columnDefs:[{ orderable:false, targets:[0,8] }]
  });
  document.getElementById('chk-all').checked = false;
  const rc = document.getElementById('result-count');
  if(rc) rc.textContent = `${data.length} annonce${data.length>1?'s':''} affich√©e${data.length>1?'s':''}`;
  updateMap(data);
}

function applyFilters() {
  const sites  = [...document.getElementById('f-site').selectedOptions].map(o=>o.value).filter(v=>v);
  const cities = [...document.getElementById('f-city').selectedOptions].map(o=>o.value).filter(v=>v);
  const pmin   = parseFloat(document.getElementById('f-pmin').value)||0;
  const pmax   = parseFloat(document.getElementById('f-pmax').value)||Infinity;
  const smin   = parseFloat(document.getElementById('f-smin').value)||0;
  const rooms  = document.getElementById('f-rooms').value;
  const dmax   = parseFloat(document.getElementById('f-dmax').value)||Infinity;
  const notif  = document.getElementById('f-notif').value;
  filtered = ALL.filter(l => {
    if(sites.length  && !sites.includes(l.site))  return false;
    if(cities.length && !cities.includes(l.city)) return false;
    if(l.price<pmin || l.price>pmax) return false;
    if(smin>0 && l.surface>0 && l.surface<smin) return false;
    if(rooms) { if(rooms==='4'){if(l.rooms<4)return false;} else{if(l.rooms&&l.rooms!=+rooms)return false;} }
    if(dmax<Infinity && l.distance_km!=null && l.distance_km>dmax) return false;
    if(notif==='1' && !l.notified) return false;
    if(notif==='0' && l.notified)  return false;
    return true;
  });
  render(filtered);
}

function resetFilters() {
  ['f-site','f-city'].forEach(id=>{ document.getElementById(id).selectedIndex=-1; });
  ['f-pmin','f-pmax','f-smin','f-dmax'].forEach(id=>{ document.getElementById(id).value=''; });
  document.getElementById('f-rooms').value='';
  document.getElementById('f-notif').value='';
  filtered=[...ALL]; render(filtered);
}

function initMap() {
  mapObj = L.map('map').setView([49.6116,6.1319],11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    {attribution:'¬© OpenStreetMap contributors', maxZoom:19}).addTo(mapObj);
  updateMap(ALL);
}

function updateMap(data) {
  if(clusterGroup) { mapObj.removeLayer(clusterGroup); }
  clusterGroup = L.markerClusterGroup({
    maxClusterRadius: 40,
    iconCreateFunction: function(cluster) {
      const n = cluster.getChildCount();
      const sz = n < 10 ? 32 : n < 50 ? 40 : 48;
      return L.divIcon({
        html: `<div style="background:#0d6efd;color:#fff;border-radius:50%;width:${sz}px;height:${sz}px;
          display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;
          box-shadow:0 2px 6px rgba(0,0,0,.35);border:2px solid #fff;">${n}</div>`,
        iconSize: [sz, sz], iconAnchor: [sz/2, sz/2], className: ''
      });
    }
  });

  let geoCount = 0;
  const bounds = [];
  data.forEach(l => {
    if(!l.latitude || !l.longitude) return;
    geoCount++;
    bounds.push([l.latitude, l.longitude]);
    const col  = dColor(l.distance_km);
    const pm2  = (l.price>0&&l.surface>0) ? Math.round(l.price/l.surface) : null;
    const icon = L.divIcon({
      html: `<div style="background:${col};width:14px;height:14px;border-radius:50%;
        border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.4);"></div>`,
      iconSize:[14,14], iconAnchor:[7,7], className:''
    });
    const popup = `
      <div style="min-width:200px;font-size:.85rem">
        <div style="font-weight:700;margin-bottom:4px">${l.city||''}</div>
        <div style="font-size:1rem;color:#0d6efd;font-weight:600">${l.price?fmt(l.price)+' ‚Ç¨':'‚Äî'}</div>
        <div class="text-muted" style="font-size:.78rem">
          ${l.surface?l.surface+' m¬≤':''}
          ${l.rooms?'¬∑ '+l.rooms+' ch':''}
          ${pm2?'¬∑ '+pm2+' ‚Ç¨/m¬≤':''}
        </div>
        ${l.distance_km!=null?'<div style="font-size:.78rem;color:#666">'+l.distance_km.toFixed(1)+' km du centre</div>':''}
        <div style="margin-top:6px;font-size:.78rem;color:#555">${trunc(l.title,60)}</div>
        <div style="margin-top:6px"><a href="${l.url}" target="_blank" class="btn btn-sm btn-outline-primary py-0 px-2">Voir l'annonce ‚Üí</a></div>
        <div style="font-size:.72rem;color:#999;margin-top:4px">${l.site||''}</div>
      </div>`;
    L.marker([l.latitude, l.longitude], {icon}).bindPopup(popup).addTo(clusterGroup);
  });

  clusterGroup.addTo(mapObj);

  // Adapter le zoom pour afficher tous les markers
  if(bounds.length > 0) {
    try { mapObj.fitBounds(bounds, {padding:[30,30], maxZoom:13}); } catch(e) {}
  }

  // Compteur sur la carte
  const mc = document.getElementById('map-count');
  if(mc) mc.textContent = geoCount;
}

function togCmp(id,chk) {
  chk.checked ? cmpSet.add(id) : cmpSet.delete(id);
  const btn=document.getElementById('compare-btn');
  document.getElementById('cmp-cnt').textContent=cmpSet.size;
  btn.style.display=cmpSet.size>=2?'inline-block':'none';
}
function toggleAll(chk) {
  document.querySelectorAll('.cchk').forEach(c=>{
    c.checked=chk.checked; chk.checked?cmpSet.add(+c.value):cmpSet.delete(+c.value);
  });
  document.getElementById('cmp-cnt').textContent=cmpSet.size;
  document.getElementById('compare-btn').style.display=cmpSet.size>=2?'inline-block':'none';
}
function openCompare() {
  const sel=ALL.filter(l=>cmpSet.has(l.id));
  if(sel.length<2) return;
  const fields=[
    ['Site',l=>l.site||'‚Äî'],['Ville',l=>l.city||'‚Äî'],
    ['Prix',l=>l.price?fmt(l.price)+' ‚Ç¨':'‚Äî'],
    ['Surface',l=>l.surface?l.surface+' m¬≤':'‚Äî'],
    ['‚Ç¨/m¬≤',l=>(l.price&&l.surface)?Math.round(l.price/l.surface*10)/10+' ‚Ç¨':'‚Äî'],
    ['Pi√®ces',l=>l.rooms||'‚Äî'],
    ['Distance',l=>l.distance_km!=null?l.distance_km.toFixed(1)+' km':'‚Äî'],
    ['Notifi√©',l=>l.notified?'‚úÖ':'‚ùå'],
    ['Date',l=>l.created_at?l.created_at.slice(0,10):'‚Äî'],
    ['Lien',l=>`<a href="${l.url}" target="_blank">Voir</a>`],
  ];
  let html='<table class="table table-sm table-bordered"><thead class="table-dark"><tr><th>Crit√®re</th>';
  sel.forEach(l=>{html+=`<th>${trunc(l.title,30)}</th>`;});
  html+='</tr></thead><tbody>';
  fields.forEach(([lbl,fn])=>{
    html+=`<tr><td class="fw-semibold">${lbl}</td>`;
    sel.forEach(l=>{html+=`<td>${fn(l)}</td>`;});
    html+='</tr>';
  });
  html+='</tbody></table>';
  document.getElementById('cmp-body').innerHTML=html;
  new bootstrap.Modal(document.getElementById('cmp-modal')).show();
}
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js')
    .then(() => console.log('PWA: Service Worker actif'))
    .catch(e  => console.warn('PWA: SW non enregistre', e));
}
</script>
</body>
</html>