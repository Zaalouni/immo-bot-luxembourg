<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Statistiques immobili√®res d√©taill√©es par ville au Luxembourg - ImmoLux">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ImmoLux Stats">
    <meta property="og:title" content="Stats Immobili√®re par Ville - ImmoLux">
    <meta property="og:description" content="D√©couvrez les prix, annonces et transports pour chaque ville du Luxembourg">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23667eea' width='180' height='180'/><text x='90' y='100' font-size='100' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle'>üìä</text></svg>">
    <title>Stats par Ville - ImmoLux</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5a6fd6;
            --primary-light: #8b9cff;
            --secondary: #764ba2;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --text-dark: #2c3e50;
            --text-light: #95a5a6;
            --border-light: #ecf0f1;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            padding-bottom: 3rem;
            color: var(--text-dark);
            min-height: 100vh;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ecf0f1;
        }

        body.dark-mode .search-container,
        body.dark-mode .city-card,
        body.dark-mode .nav-container {
            background: rgba(255, 255, 255, 0.05);
            color: #ecf0f1;
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header small {
            opacity: 0.85;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: block;
        }

        /* NAV HORIZONTAL */
        .nav-container {
            display: flex;
            gap: 0.3rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            transition: var(--transition);
            white-space: nowrap;
        }

        .nav-link:hover,
        .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.2);
        }

        /* CONTAINER */
        .container-main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* SEARCH SECTION */
        .search-container {
            background: var(--bg-white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .controls-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn-control {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-control.primary {
            background: var(--primary);
            color: white;
        }

        .btn-control.primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-control.secondary {
            background: var(--bg-light);
            color: var(--text-dark);
            border: 2px solid var(--border-light);
        }

        .btn-control.secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* CITY CARDS */
        .cities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .cities-grid {
                grid-template-columns: 1fr;
            }
        }

        .city-card {
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: var(--transition);
            border: 1px solid var(--border-light);
        }

        .city-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .city-header-section {
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-bottom: 2px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .city-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }

        .city-info {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.3rem;
        }

        .city-badge {
            background: var(--primary);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .city-content {
            padding: 1.5rem;
        }

        /* TABS */
        .city-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-light);
        }

        .city-tab-btn {
            padding: 0.7rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            white-space: nowrap;
        }

        .city-tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .city-tab-btn:hover {
            color: var(--primary);
        }

        .city-tab-content {
            display: none;
        }

        .city-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--bg-light) 0%, rgba(102, 126, 234, 0.05) 100%);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-light);
            transition: var(--transition);
        }

        .stat-card:hover {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .stat-card:hover .stat-label {
            color: rgba(255, 255, 255, 0.85);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.3rem;
        }

        .stat-card:hover .stat-value {
            color: white;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            transition: var(--transition);
        }

        /* LISTINGS TABLE */
        .listings-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border-light);
        }

        .listings-table {
            width: 100%;
            font-size: 0.85rem;
            border-collapse: collapse;
            margin: 0;
        }

        .listings-table thead {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .listings-table th {
            padding: 1rem;
            font-weight: 600;
            text-align: left;
            white-space: nowrap;
        }

        .listings-table td {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
        }

        .listings-table tbody tr:hover {
            background: var(--bg-light);
            transition: var(--transition);
        }

        .listings-table tbody tr:last-child td {
            border-bottom: none;
        }

        .site-badge {
            display: inline-block;
            padding: 0.3rem 0.7rem;
            border-radius: 4px;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            background: var(--primary);
        }

        .price-cell {
            font-weight: 700;
            color: var(--primary);
        }

        .link-cell a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
        }

        .link-cell a:hover {
            text-decoration: underline;
        }

        /* TRANSPORTS SECTION */
        .transports-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }

        .transport-card {
            background: linear-gradient(135deg, var(--bg-light) 0%, rgba(102, 126, 234, 0.05) 100%);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            transition: var(--transition);
        }

        .transport-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .transport-type {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.85rem;
            text-transform: uppercase;
            margin-bottom: 0.3rem;
        }

        .transport-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.3rem;
        }

        .transport-desc {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .transport-duration {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* DARK MODE TOGGLE */
        .dark-mode-toggle {
            position: fixed;
            bottom: 2rem;
            right: 1rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dark-mode-toggle:hover {
            transform: scale(1.1);
            background: var(--primary-dark);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.4rem;
            }

            .container-main {
                padding: 1rem 0.5rem;
            }

            .search-container {
                flex-direction: column;
            }

            .search-box {
                min-width: unset;
            }

            .cities-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .transports-container {
                grid-template-columns: 1fr;
            }

            .listings-table {
                font-size: 0.75rem;
            }

            .listings-table th,
            .listings-table td {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <div class="header-content">
            <h1>üìä Stats Immobili√®res par Ville</h1>
            <small id="lastUpdate"></small>
            <div class="nav-container">
                <a href="index.html" class="nav-link">üè† Dashboard</a>
                <a href="map.html" class="nav-link">üó∫Ô∏è Carte</a>
                <a href="map-advanced.html" class="nav-link">üó∫Ô∏è Carte+</a>
                <a href="new-listings.html" class="nav-link">‚≠ê Nouvelles</a>
                <a href="anomalies.html" class="nav-link">‚ö†Ô∏è Anomalies</a>
                <a href="stats-by-city.html" class="nav-link active">üìä Stats</a>
                <a href="photos.html" class="nav-link">üì∏ Photos</a>
            </div>
        </div>
    </div>

    <!-- SEARCH & CONTROLS -->
    <div class="container-main">
        <div class="search-container">
            <div class="search-box" style="flex: 1; min-width: 250px;">
                <input type="text" id="searchInput" placeholder="üîç Chercher une ville..." onkeyup="filterCities()">
            </div>
            <div class="controls-group">
                <button class="btn-control secondary" onclick="resetFilters()">‚Üª R√©initialiser</button>
                <button class="btn-control secondary" onclick="exportCSV()">üì• Export CSV</button>
            </div>
        </div>

        <!-- CITIES GRID -->
        <div id="results" class="cities-grid"></div>
    </div>

    <!-- DARK MODE TOGGLE -->
    <button class="dark-mode-toggle" id="darkModeToggle" title="Mode sombre">üåô</button>

    <script>
        // ==================== DATA ====================
        const LISTINGS_DATA = [
  {
    "listing_id": "vivi_208174",
    "site": "VIVI.lu",
    "title": "Appartement 2 chambres √† louer",
    "city": "Schouweiler",
    "price": 2050,
    "rooms": 2,
    "surface": 82,
    "url": "https://www.vivi.lu/fr/propriete/lieu/appartement/schouweiler/appartement-2-chambres-a-louer/208174",
    "price_m2": 25.0
  },
  {
    "listing_id": "vivi_208177",
    "site": "VIVI.lu",
    "title": "Appartement 2 chambres √† louer",
    "city": "Schouweiler",
    "price": 1995,
    "rooms": 2,
    "surface": 87,
    "url": "https://www.vivi.lu/fr/propriete/lieu/appartement/schouweiler/appartement-2-chambres-a-louer/208177",
    "price_m2": 22.9
  },
  {
    "listing_id": "athome_7901304",
    "site": "Athome.lu",
    "title": "Bel appartement de 80 m2 avec 2 chambres √† coucher",
    "city": "Luxembourg",
    "price": 1900,
    "rooms": 2,
    "surface": 80,
    "url": "https://www.athome.lu/en/property/8/apartment-to-rent/luxembourg/luxembourg?id=7901304",
    "price_m2": 23.75
  },
  {
    "listing_id": "athome_7901260",
    "site": "Athome.lu",
    "title": "Moderne Wohnung Nummer 2 Bed mit Balkon, Bascharage",
    "city": "Bascharage",
    "price": 1500,
    "rooms": 2,
    "surface": 95,
    "url": "https://www.athome.lu/en/property/8/apartment-to-rent/luxembourg/bascharage?id=7901260",
    "price_m2": 15.79
  },
  {
    "listing_id": "vivi_208188",
    "site": "VIVI.lu",
    "title": "Maison 2 chambres √† louer",
    "city": "Bertrange",
    "price": 2200,
    "rooms": 2,
    "surface": 110,
    "url": "https://www.vivi.lu/fr/propriete/lieu/maison/bertrange/maison-2-chambres-a-louer/208188",
    "price_m2": 20.0
  },
  {
    "listing_id": "vivi_212688",
    "site": "VIVI.lu",
    "title": "Appartement 2 chambres √† louer",
    "city": "Bastendorf",
    "price": 1600,
    "rooms": 2,
    "surface": 91,
    "url": "https://www.vivi.lu/fr/propriete/lieu/appartement/bastendorf/appartement-2-chambres-a-louer/212688",
    "price_m2": 17.6
  }
        ];

        const TRANSPORTS_DATA = {
          "Luxembourg": {
            "region": "Centre",
            "distance_km": 0,
            "transports": [
              {
                "type": "train",
                "number": "IC 100",
                "duration_min": 0,
                "description": "Gare Centrale - Centre Ville"
              }
            ]
          },
          "Bertrange": {
            "region": "Ouest",
            "distance_km": 6,
            "transports": [
              {
                "type": "bus",
                "number": "13",
                "duration_min": 15,
                "description": "Bus Bertrange to Gare"
              },
              {
                "type": "car",
                "number": "Voiture",
                "duration_min": 8,
                "description": "Voiture √† Gare Centrale"
              }
            ]
          },
          "Bascharage": {
            "region": "Sud",
            "distance_km": 13,
            "transports": [
              {
                "type": "bus",
                "number": "24",
                "duration_min": 20,
                "description": "Bus Bascharage to Gare"
              }
            ]
          },
          "Schouweiler": {
            "region": "Centre",
            "distance_km": 8,
            "transports": [
              {
                "type": "bus",
                "number": "10",
                "duration_min": 18,
                "description": "Bus Schouweiler to Gare"
              }
            ]
          },
          "Bastendorf": {
            "region": "Nord",
            "distance_km": 22,
            "transports": [
              {
                "type": "bus",
                "number": "5",
                "duration_min": 35,
                "description": "Bus Bastendorf to Gare"
              }
            ]
          }
        };

        // ==================== STATE ====================
        let cityData = {};
        let allCities = [];

        // ==================== INIT ====================
        function init() {
            document.getElementById('lastUpdate').textContent = `Mis √† jour: ${new Date().toLocaleString('fr-FR')}`;

            const byCity = {};
            LISTINGS_DATA.forEach(l => {
                const city = l.city || 'N/A';
                if (!byCity[city]) byCity[city] = [];
                byCity[city].push(l);
            });

            allCities = Object.keys(byCity).sort();
            allCities.forEach(city => {
                const listings = byCity[city];
                const prices = listings.map(l => l.price).filter(p => p > 0);
                const surfaces = listings.map(l => l.surface).filter(s => s > 0);
                const rooms = listings.map(l => l.rooms).filter(r => r > 0);

                cityData[city] = {
                    count: listings.length,
                    minPrice: Math.min(...prices),
                    maxPrice: Math.max(...prices),
                    avgPrice: Math.round(prices.reduce((a, b) => a + b, 0) / prices.length),
                    medianPrice: prices.length > 0 ? prices.sort((a, b) => a - b)[Math.floor(prices.length / 2)] : 0,
                    avgSurface: surfaces.length > 0 ? Math.round(surfaces.reduce((a, b) => a + b, 0) / surfaces.length) : 0,
                    avgRooms: rooms.length > 0 ? (rooms.reduce((a, b) => a + b, 0) / rooms.length).toFixed(1) : '‚Äî',
                    transport: TRANSPORTS_DATA[city] || null,
                    listings: listings.sort((a, b) => a.price - b.price)
                };
            });

            renderCities();
            setupDarkMode();
        }

        // ==================== DARK MODE ====================
        function setupDarkMode() {
            const toggle = document.getElementById('darkModeToggle');
            const savedMode = localStorage.getItem('darkMode') === 'true';

            if (savedMode) {
                document.body.classList.add('dark-mode');
                toggle.textContent = '‚òÄÔ∏è';
            }

            toggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                localStorage.setItem('darkMode', isDark);
                toggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            });
        }

        // ==================== RENDERING ====================
        function renderCities() {
            const container = document.getElementById('results');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            const filtered = allCities.filter(city =>
                city.toLowerCase().includes(searchTerm) || searchTerm === ''
            );

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><p>Aucune ville ne correspond</p></div>';
                return;
            }

            container.innerHTML = filtered.map(city => {
                const data = cityData[city];

                return `
                    <div class="city-card">
                        <div class="city-header-section">
                            <div>
                                <h2 class="city-name">${city}</h2>
                                <div class="city-info">${data.transport?.region || 'Luxembourg'}</div>
                                ${data.transport?.distance_km ? `<div class="city-info">üìç ${data.transport.distance_km} km de la Gare</div>` : ''}
                            </div>
                            <div class="city-badge">${data.count} annonces</div>
                        </div>

                        <div class="city-content">
                            <!-- TABS -->
                            <div class="city-tabs">
                                <button class="city-tab-btn active" onclick="switchTab(this, '${city}', 'stats')">üìä Stats</button>
                                <button class="city-tab-btn" onclick="switchTab(this, '${city}', 'listings')">üìã Annonces</button>
                                <button class="city-tab-btn" onclick="switchTab(this, '${city}', 'transports')">üöå Transports</button>
                            </div>

                            <!-- TAB: STATS -->
                            <div class="city-tab-content active" data-tab="${city}-stats">
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-value">${data.minPrice.toLocaleString('fr-FR')}‚Ç¨</div>
                                        <div class="stat-label">Min</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${data.avgPrice.toLocaleString('fr-FR')}‚Ç¨</div>
                                        <div class="stat-label">Moyen</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${data.maxPrice.toLocaleString('fr-FR')}‚Ç¨</div>
                                        <div class="stat-label">Max</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${data.medianPrice.toLocaleString('fr-FR')}‚Ç¨</div>
                                        <div class="stat-label">M√©dian</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${data.avgSurface}m¬≤</div>
                                        <div class="stat-label">Surface</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${data.avgRooms}</div>
                                        <div class="stat-label">Ch. Avg</div>
                                    </div>
                                </div>
                            </div>

                            <!-- TAB: LISTINGS -->
                            <div class="city-tab-content" data-tab="${city}-listings">
                                <div class="listings-container">
                                    <table class="listings-table">
                                        <thead>
                                            <tr>
                                                <th style="width: 15%;">Site</th>
                                                <th style="width: 35%;">Titre</th>
                                                <th style="width: 12%;">Prix</th>
                                                <th style="width: 8%;">Ch.</th>
                                                <th style="width: 10%;">m¬≤</th>
                                                <th style="width: 12%;">‚Ç¨/m¬≤</th>
                                                <th style="width: 8%;">Lien</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.listings.map(l => `
                                                <tr>
                                                    <td><span class="site-badge">${l.site}</span></td>
                                                    <td><strong>${l.title || 'Sans titre'}</strong></td>
                                                    <td class="price-cell">${l.price ? l.price.toLocaleString('fr-FR') + '‚Ç¨' : '‚Äî'}</td>
                                                    <td>${l.rooms || '‚Äî'}</td>
                                                    <td>${l.surface || '‚Äî'}</td>
                                                    <td>${l.price_m2 ? l.price_m2.toFixed(0) + '‚Ç¨' : '‚Äî'}</td>
                                                    <td class="link-cell"><a href="${l.url}" target="_blank">Voir ‚Üí</a></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- TAB: TRANSPORTS -->
                            <div class="city-tab-content" data-tab="${city}-transports">
                                ${data.transport && data.transport.transports.length > 0 ? `
                                    <div class="transports-container">
                                        ${data.transport.transports.map(t => `
                                            <div class="transport-card">
                                                <div class="transport-type">${t.type.toUpperCase()}</div>
                                                <div class="transport-number">${t.number}</div>
                                                <div class="transport-desc">${t.description}</div>
                                                <div class="transport-duration">‚è±Ô∏è ${t.duration_min} min</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-light);">
                                        üìç <strong>${data.transport.distance_km} km</strong> de la Gare Centrale
                                    </p>
                                ` : '<p style="color: var(--text-light);">Aucune donn√©e de transport disponible</p>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== INTERACTIONS ====================
        function switchTab(button, city, tab) {
            button.parentElement.querySelectorAll('.city-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            button.closest('.city-content').querySelectorAll('.city-tab-content').forEach(content => {
                content.classList.remove('active');
            });

            button.classList.add('active');
            document.querySelector(`[data-tab="${city}-${tab}"]`).classList.add('active');
        }

        function filterCities() {
            renderCities();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            renderCities();
        }

        function exportCSV() {
            let csv = 'Ville,NbAnnonces,PrixMin,PrixMoyen,PrixMax,SurfaceMoy,ChambresAvg,Distance,Transport\n';

            allCities.forEach(city => {
                const data = cityData[city];
                const transport = data.transport ? `${data.transport.distance_km}km - ${data.transport.transports.map(t => t.number).join(', ')}` : 'N/A';
                csv += `"${city}",${data.count},${data.minPrice},${data.avgPrice},${data.maxPrice},${data.avgSurface},${data.avgRooms},"${transport}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ImmoLux-Stats-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // ==================== SERVICE WORKER ====================
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed'));
        }

        // ==================== INIT ====================
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
